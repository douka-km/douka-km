{% extends 'base.html' %}

{% block title %}{{ product.name }} - DOUKA KM{% endblock %}

{% block content %}
<div class="product-detail-page">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Accueil</a></li>
                    <li class="breadcrumb-item"><a href="/products">Produits</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-5">
        <!-- Product Images -->
        <div class="col-md-6 mb-4">
            <div class="product-image-container">
                <img src="{{ product.image }}" alt="{{ product.name }}" class="img-fluid rounded main-image mb-3"
                     onerror="this.src='https://via.placeholder.com/600x400?text=Image+non+disponible'">
                
                {% if product.images and product.images|length > 1 %}
                <div class="image-gallery-container">
                    <!-- Affichage dynamique de toutes les images -->
                    <div class="row thumbnail-images" id="thumbnailContainer">
                        {% for image_url in product.images %}
                        <div class="col-3 col-md-2 col-lg-3 mb-2">
                            <img src="{{ image_url }}" alt="Image {{ loop.index }}" 
                                 class="img-thumbnail{% if loop.first %} active{% endif %}"
                                 data-image-index="{{ loop.index0 }}"
                                 onerror="this.src='https://via.placeholder.com/150x150?text=Image+{{ loop.index }}'">
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Navigation pour la galerie si plus de 4 images -->
                    {% if product.images|length > 4 %}
                    <div class="gallery-navigation text-center mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" id="prevImages" disabled>
                            <i class="fas fa-chevron-left"></i> Précédent
                        </button>
                        <span class="gallery-counter">
                            <span id="currentStart">1</span>-<span id="currentEnd">{{ [4, product.images|length]|min }}</span> 
                            sur {{ product.images|length }} images
                        </span>
                        <button type="button" class="btn btn-sm btn-outline-primary ms-2" id="nextImages" 
                                {% if product.images|length <= 4 %}disabled{% endif %}>
                            Suivant <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    {% endif %}
                    
                    <!-- Modal pour affichage en grand -->
                    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Galerie d'images - {{ product.name }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body text-center">
                                    <img id="modalImage" src="" alt="Image agrandie" class="img-fluid rounded">
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-outline-secondary me-2" id="modalPrev">
                                            <i class="fas fa-chevron-left"></i> Précédente
                                        </button>
                                        <span class="modal-counter">
                                            <span id="modalCurrent">1</span> / {{ product.images|length }}
                                        </span>
                                        <button type="button" class="btn btn-outline-secondary ms-2" id="modalNext">
                                            Suivante <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Product Info -->
        <div class="col-md-6">
            <div class="product-info">
                <h1 class="mb-2">{{ product.name }}</h1>
                <div class="d-flex align-items-center mb-3">
                    <div class="rating me-2">
                        {% for i in range(1, 6) %}
                            {% if i <= product.rating|int %}
                                <i class="fas fa-star text-warning"></i>
                            {% elif i <= product.rating + 0.5 %}
                                <i class="fas fa-star-half-alt text-warning"></i>
                            {% else %}
                                <i class="far fa-star text-warning"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <span class="text-muted small">{{ product.reviews }} avis</span>
                </div>
                
                <div class="price mb-4">
                    <span class="fw-bold fs-4" id="display-price">{{ product.price|format_number }} KMF</span>
                    <span id="original-price" class="text-muted text-decoration-line-through ms-2" style="display: none;">{{ product.price|format_number }} KMF</span>
                    {% if product.old_price %}
                        <span class="text-muted text-decoration-line-through ms-2">{{ product.old_price|format_number }} KMF</span>
                        <span class="badge bg-danger ms-2">-{{ (((product.old_price - product.price) / product.old_price) * 100)|int }}%</span>
                    {% endif %}
                </div>
                
                <!-- Information sur le stock -->
                {% if product.stock is defined %}
                <div class="stock-info mb-3">
                    {% if product.stock > 0 %}
                        {% if product.stock <= 5 %}
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Plus que {{ product.stock }} en stock
                            </span>
                        {% elif product.stock <= 10 %}
                            <span class="badge bg-info">
                                <i class="fas fa-info-circle me-1"></i>
                                {{ product.stock }} en stock
                            </span>
                        {% else %}
                            <span class="badge bg-success">
                                <i class="fas fa-check-circle me-1"></i>
                                En stock ({{ product.stock }})
                            </span>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-danger">
                            <i class="fas fa-times-circle me-1"></i>
                            Rupture de stock
                        </span>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Informations du marchand -->
                {% if product.merchant_name %}
                <div class="merchant-info mb-3">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-store me-2 text-primary"></i>
                        <span class="text-muted">Vendu par:</span>
                        <strong class="ms-2">{{ product.merchant_name }}</strong>
                    </div>
                </div>
                {% endif %}
                
                <!-- Options du produit - Section ajoutée -->
                <div class="product-options mb-4">
                    <!-- Option de couleur -->
                    {% if product.colors is defined and product.colors %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">Couleur</label>
                        <div class="d-flex flex-wrap gap-2" id="color-options">
                            {% for color in product.colors %}
                            <div class="form-check color-option">
                                <input type="radio" name="color" id="color-{{ color.value }}" value="{{ color.value }}" class="form-check-input option-selector" 
                                       data-option-type="color" {% if loop.first %}checked{% endif %}>
                                <label for="color-{{ color.value }}" class="form-check-label color-label d-flex align-items-center">
                                    <span class="color-circle me-2" style="background-color: {{ color.hex }}"></span>
                                    {{ color.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Option de taille -->
                    {% if product.sizes is defined and product.sizes %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">Taille</label>
                        <div class="d-flex flex-wrap gap-2">
                            {% for size in product.sizes %}
                            <div class="form-check">
                                <input type="radio" name="size" id="size-{{ size.value|default(size) }}" value="{{ size.value|default(size) }}" class="form-check-input option-selector"
                                       data-option-type="size" {% if loop.first %}checked{% endif %}>
                                <label for="size-{{ size.value|default(size) }}" class="form-check-label">
                                    {{ size.label|default(size) }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Option de stockage -->
                    {% if product.storage_options is defined and product.storage_options %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">Stockage</label>
                        <select class="form-select option-selector" name="storage" id="storage-select" data-option-type="storage">
                            {% for option in product.storage_options %}
                            <option value="{{ option.value }}" data-price-modifier="{{ option.price_modifier|default(0) }}">
                                {{ option.label }}
                                {% if option.price_modifier|default(0) > 0 %}
                                    (+{{ option.price_modifier|format_number }} KMF)
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <!-- Autres options spécifiques -->
                    {% if product.options is defined and product.options %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">Options</label>
                        {% for option in product.options %}
                        <div class="mb-2">
                            <label class="form-label">{{ option.name }}</label>
                            <select class="form-select" name="option_{{ option.id }}">
                                {% for value in option.values %}
                                <option value="{{ value.id }}">{{ value.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="product-actions mb-4">
                    <div class="quantity-selector d-flex align-items-center mb-3">
                        <label for="quantity" class="form-label mb-0 me-3">Quantité:</label>
                        <div class="input-group" style="width: 150px;">
                            <button type="button" class="btn btn-outline-secondary decrease-qty" 
                                    {% if product.stock is defined and product.stock <= 0 %}disabled{% endif %}>-</button>
                            <input type="number" id="quantity" class="form-control text-center" value="1" min="1" 
                                   max="{{ product.stock if product.stock else 99 }}"
                                   {% if product.stock is defined and product.stock <= 0 %}disabled{% endif %}>
                            <button type="button" class="btn btn-outline-secondary increase-qty"
                                    {% if product.stock is defined and product.stock <= 0 %}disabled{% endif %}>+</button>
                        </div>
                        {% if product.stock %}
                        <small class="text-muted ms-2">Stock: {{ product.stock }}</small>
                        {% endif %}
                    </div>
                    
                    <!-- Ajouter un bouton "Ajouter à la liste d'envies" à proximité du bouton "Ajouter au panier" -->
                    <div class="d-flex gap-2 mt-3">
                        <form action="{{ url_for('add_to_cart', product_id=product.id) }}" method="post" class="flex-grow-1" id="addToCartForm">
                            <input type="hidden" name="quantity" id="form-quantity" value="1">
                            <input type="hidden" name="options" id="options-input" value="{}">
                            <input type="hidden" name="price_modifier" id="price-modifier-input" value="0">
                            <button type="submit" class="btn btn-primary w-100" id="addToCartBtn" 
                                    {% if product.stock is defined and product.stock <= 0 %}disabled{% endif %}>
                                <i class="fas fa-cart-plus me-1"></i> 
                                {% if product.stock is defined and product.stock <= 0 %}
                                    Rupture de stock
                                {% else %}
                                    Ajouter au panier
                                {% endif %}
                            </button>
                        </form>
                        {% if user %}
                            <div class="wishlist-btn-container">
                                {% if in_wishlist %}
                                <form action="{{ url_for('remove_from_wishlist', product_id=product.id) }}" method="POST" class="d-inline wishlist-form">
                                    <button type="submit" class="btn btn-outline-danger already-in-wishlist" title="Retirer de ma liste d'envies">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                </form>
                                {% else %}
                                <form action="{{ url_for('add_to_wishlist', product_id=product.id) }}" method="POST" class="d-inline wishlist-form">
                                    <button type="submit" class="btn btn-outline-secondary add-to-wishlist" title="Ajouter à ma liste d'envies">
                                        <i class="far fa-heart"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <hr class="my-4">
                
                <div class="d-flex product-actions">
                    <button id="shareProductBtn" class="btn btn-link text-decoration-none" title="Partager ce produit">
                        <i class="fas fa-share-alt"></i> Partager
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Details Tabs -->
    <div class="row mb-5">
        <div class="col">
            <ul class="nav nav-tabs" id="productTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">
                        <i class="fas fa-info-circle me-2"></i>Détails
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab" aria-controls="reviews" aria-selected="false">
                        <i class="fas fa-star me-2"></i>Avis ({{ product.reviews }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="shipping-tab" data-bs-toggle="tab" data-bs-target="#shipping" type="button" role="tab" aria-controls="shipping" aria-selected="false">
                        <i class="fas fa-shipping-fast me-2"></i>Livraison
                    </button>
                </li>
            </ul>
            <div class="tab-content" id="productTabsContent">
                <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                    <!-- Description du produit -->
                    <div class="product-description">
                        <h5 class="mb-3">
                            <i class="fas fa-file-alt me-2"></i>Description du produit
                        </h5>
                        <p>{{ product.description }}</p>
                    </div>
                    
                    <!-- Spécifications techniques -->
                    {% if product.specifications is defined and product.specifications %}
                    <div class="specifications-section">
                        <h5 class="specifications-title">
                            <i class="fas fa-cogs"></i>Spécifications techniques
                        </h5>
                        <div class="specifications-table">
                            <table class="table">
                                <tbody>
                                    {% for key, value in product.specifications.items() %}
                                    <tr>
                                        <td>{{ key }}</td>
                                        <td>{{ value }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Informations additionnelles (section debug améliorée) -->
                    <div class="additional-info">
                        <h6>
                            <i class="fas fa-info-circle"></i>Informations supplémentaires
                        </h6>
                        <ul class="list-unstyled mb-0">
                            <li>
                                <strong>Options de couleur:</strong> 
                                {% if product.colors is defined and product.colors %}
                                    {{ product.colors|length }} couleur(s) disponible(s)
                                {% else %}
                                    Couleur standard
                                {% endif %}
                            </li>
                            <li>
                                <strong>Options de taille:</strong> 
                                {% if product.sizes is defined and product.sizes %}
                                    {{ product.sizes|length }} taille(s) disponible(s)
                                {% else %}
                                    Taille unique
                                {% endif %}
                            </li>
                            <li>
                                <strong>Garantie:</strong> 
                                {{ product.warranty|default('1 an de garantie constructeur') }}
                            </li>
                            <li>
                                <strong>Marque:</strong> 
                                {{ product.brand|default('Marque de qualité') }}
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                    <div class="reviews-section">
                        <div class="reviews-summary">
                            <h4>
                                <i class="fas fa-comments"></i>Avis des clients
                            </h4>
                            <div class="rating-display">
                                <div class="rating-number">{{ product.rating }}</div>
                                <div class="rating-stars">
                                    <div class="mb-2">
                                        {% for i in range(1, 6) %}
                                            {% if i <= product.rating|int %}
                                                <i class="fas fa-star text-warning"></i>
                                            {% elif i <= product.rating + 0.5 %}
                                                <i class="fas fa-star-half-alt text-warning"></i>
                                            {% else %}
                                                <i class="far fa-star text-warning"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <p class="mb-0 text-muted">Basé sur {{ reviews_count|default(product.reviews) }} avis</p>
                                </div>
                            </div>
                            
                            <!-- Avis réels -->
                            {% if reviews %}
                                {% for review in reviews %}
                                <div class="review-item">
                                    <div class="review-header">
                                        <div class="review-stars">
                                            {% for i in range(1, 6) %}
                                                {% if i <= review.rating %}
                                                    <i class="fas fa-star text-warning"></i>
                                                {% else %}
                                                    <i class="far fa-star text-warning"></i>
                                                {% endif %}
                                            {% endfor %}
                                            {% if review.verified_purchase %}
                                                <span class="badge bg-success small">Achat vérifié</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if review.title %}
                                        <div class="review-title">{{ review.title }}</div>
                                    {% endif %}
                                    {% if review.comment %}
                                        <div class="review-comment">{{ review.comment }}</div>
                                    {% endif %}
                                    <div class="review-meta">
                                        <span><i class="fas fa-user me-1"></i>{{ review.user_name }}</span>
                                        <span><i class="fas fa-calendar me-1"></i>{{ review.created_at[:10] }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-comments fa-3x mb-3 text-muted opacity-50"></i>
                                    <h5>Aucun avis pour ce produit</h5>
                                    <p>Soyez le premier à donner votre avis !</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="reviews-summary">
                            <!-- Section pour écrire un avis désactivée -->
                            <div class="alert alert-info border-0 shadow-sm">
                                <h5 class="alert-heading">
                                    <i class="fas fa-info-circle me-2"></i>Avis clients
                                </h5>
                                <p class="mb-2">
                                    La fonction d'écriture d'avis est temporairement désactivée. 
                                    Vous pouvez consulter les avis existants ci-contre.
                                </p>
                                <hr class="my-3">
                                <p class="mb-0">
                                    <i class="fas fa-envelope me-2"></i>
                                    <small>Pour toute question sur ce produit, n'hésitez pas à nous contacter directement.</small>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="shipping" role="tabpanel" aria-labelledby="shipping-tab">
                    <div class="shipping-section">
                        <h4>
                            <i class="fas fa-shipping-fast"></i>Informations de livraison
                        </h4>
                        
                        <div class="shipping-locations">
                            <h5>
                                <i class="fas fa-map-marker-alt"></i>Zones de livraison
                            </h5>
                            <p class="mb-3">Nous livrons sur toutes les îles des Comores :</p>
                            <ul>
                                {% for location, time in shipping_info.delivery_times.regions.items() %}
                                <li><strong>{{ location }}:</strong> Livraison sous {{ time }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <div class="shipping-fees">
                            <h5>
                                <i class="fas fa-money-bill-wave"></i>Frais de livraison
                            </h5>
                            
                            <!-- Tarifs de livraison selon le type -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-primary mb-3">
                                        <div class="card-header bg-primary text-white">
                                            <i class="fas fa-truck me-2"></i>Livraison Standard
                                        </div>
                                        <div class="card-body">
                                            <h5 class="card-title text-primary">{{ shipping_info.standard_rate|format_number }} KMF</h5>
                                            <p class="card-text">
                                                <i class="fas fa-clock me-1"></i>{{ shipping_info.delivery_times.standard }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="card border-info mb-3">
                                        <div class="card-header bg-info text-white">
                                            <i class="fas fa-bolt me-2"></i>Livraison Express
                                        </div>
                                        <div class="card-body">
                                            <h5 class="card-title text-info">{{ shipping_info.express_rate|format_number }} KMF</h5>
                                            <p class="card-text">
                                                <i class="fas fa-bolt me-1"></i>{{ shipping_info.delivery_times.express }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Information sur la livraison gratuite -->
                            <div class="alert alert-success">
                                <i class="fas fa-gift me-2"></i>
                                <strong>Livraison gratuite</strong> pour les commandes supérieures à {{ shipping_info.free_shipping_threshold|format_number }} KMF
                            </div>
                        </div>
                        
                        <div class="alert alert-success border-0 shadow-sm">
                            <h6 class="alert-heading">
                                <i class="fas fa-headset me-2"></i>Besoin d'aide ?
                            </h6>
                            <p class="mb-0">
                                Pour toute question concernant la livraison, n'hésitez pas à nous contacter. 
                                Notre équipe est là pour vous aider !
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Products -->
    <div class="row mb-4">
        <div class="col">
            <h2 class="section-heading">
                <i class="fas fa-th-large me-2"></i>Produits similaires
                {% if product.category_name %}
                <small class="text-muted fs-6">dans {{ product.category_name }}</small>
                {% endif %}
            </h2>
        </div>
    </div>
    
    {% if related_products %}
    <div class="row row-cols-2 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
        {% for related_product in related_products %}
        <div class="col">
            <div class="card h-100 shadow-sm related-product-card">
                <div class="position-relative overflow-hidden">
                    <a href="{{ url_for('product_detail', product_id=related_product.id) }}" class="text-decoration-none">
                        <div class="card-img-container">
                            {% if related_product.image %}
                                {% if related_product.image.startswith('http') %}
                                    <!-- Image via URL -->
                                    <img src="{{ related_product.image }}" 
                                         class="card-img-top related-product-img" 
                                         alt="{{ related_product.name }}"
                                         loading="lazy"
                                         onerror="this.onerror=null; this.src='https://via.placeholder.com/400x300/f8f9fa/6c757d?text=Produit';">
                                {% else %}
                                    <!-- Image locale -->
                                    <img src="{{ url_for('static', filename=related_product.image.replace('static/', '') if related_product.image.startswith('static/') else related_product.image) }}" 
                                         class="card-img-top related-product-img" 
                                         alt="{{ related_product.name }}"
                                         loading="lazy"
                                         onerror="this.onerror=null; this.src='https://via.placeholder.com/400x300/f8f9fa/6c757d?text=Produit';">
                                {% endif %}
                            {% else %}
                                <!-- Image placeholder -->
                                <img src="https://via.placeholder.com/400x300/f8f9fa/6c757d?text=Produit" 
                                     class="card-img-top related-product-img" 
                                     alt="Aucune image">
                            {% endif %}
                            
                            <!-- Badge de promotion si applicable -->
                            {% if related_product.old_price and related_product.old_price > related_product.price %}
                            <span class="badge bg-danger position-absolute top-0 start-0 m-2">
                                -{{ (((related_product.old_price - related_product.price) / related_product.old_price) * 100)|int }}%
                            </span>
                            {% endif %}
                            
                            <!-- Badge de stock faible -->
                            {% if related_product.stock is defined and related_product.stock <= 5 and related_product.stock > 0 %}
                            <span class="badge bg-warning text-dark position-absolute top-0 end-0 m-2">
                                <i class="fas fa-exclamation-triangle"></i> Stock faible
                            </span>
                            {% elif related_product.stock is defined and related_product.stock <= 0 %}
                            <span class="badge bg-secondary position-absolute top-0 end-0 m-2">
                                Rupture
                            </span>
                            {% endif %}
                        </div>
                    </a>
                </div>
                
                <div class="card-body d-flex flex-column">
                    <a href="{{ url_for('product_detail', product_id=related_product.id) }}" class="text-decoration-none text-dark">
                        <h6 class="card-title mb-2" title="{{ related_product.name }}">{{ related_product.name[:50] }}{% if related_product.name|length > 50 %}...{% endif %}</h6>
                    </a>
                    
                    <!-- Rating -->
                    <div class="mb-2">
                        <div class="d-flex align-items-center">
                            {% for i in range(1, 6) %}
                                {% if i <= related_product.rating|default(0)|int %}
                                    <i class="fas fa-star text-warning small"></i>
                                {% elif i <= related_product.rating|default(0) + 0.5 %}
                                    <i class="fas fa-star-half-alt text-warning small"></i>
                                {% else %}
                                    <i class="far fa-star text-warning small"></i>
                                {% endif %}
                            {% endfor %}
                            <small class="text-muted ms-1">({{ related_product.reviews|default(0) }})</small>
                        </div>
                    </div>
                    
                    <!-- Prix -->
                    <div class="mb-3">
                        <div class="price-container">
                            <span class="fw-bold text-primary fs-6">{{ related_product.price|format_number }} KMF</span>
                            {% if related_product.old_price and related_product.old_price > related_product.price %}
                                <small class="text-muted text-decoration-line-through ms-1">{{ related_product.old_price|format_number }} KMF</small>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Bouton d'action -->
                    <div class="mt-auto">
                        {% if related_product.stock is defined and related_product.stock <= 0 %}
                            <button class="btn btn-outline-secondary btn-sm w-100" disabled>
                                <i class="fas fa-times-circle me-1"></i>Rupture de stock
                            </button>
                        {% else %}
                            <button class="btn btn-primary btn-sm w-100 add-to-cart-related" data-product-id="{{ related_product.id }}">
                                <i class="fas fa-cart-plus me-1"></i>Ajouter au panier
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Aucun produit similaire trouvé</h5>
                <p class="text-muted">Découvrez d'autres produits dans notre catalogue</p>
                <a href="{{ url_for('products') }}" class="btn btn-outline-primary">
                    <i class="fas fa-eye me-2"></i>Voir tous les produits
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Définir les variables pour le prix
    const basePrice = {{ product.price }};
    const displayPrice = document.getElementById('display-price');
    const originalPrice = document.getElementById('original-price');
    
    // Définir les combinaisons de prix s'il y en a
    const priceCombinations = {{ product.price_combinations|default([])|tojson }};
    
    console.log('=== DEBUG PRODUIT COMPLET ===');
    console.log('Toutes les données du produit:', {{ product|tojson }});
    console.log('Couleurs disponibles:', {{ product.colors|default([])|tojson }});
    console.log('Tailles disponibles:', {{ product.sizes|default([])|tojson }});
    console.log('Combinaisons de prix:', priceCombinations);
    
    // Fonction pour mettre à jour le prix affiché
    function updateDisplayPrice() {
        const currentPrice = getCurrentPrice();
        displayPrice.textContent = formatNumber(currentPrice) + ' KMF';
        
        // Afficher ou masquer le prix original
        if (currentPrice !== basePrice) {
            originalPrice.style.display = 'inline';
        } else {
            originalPrice.style.display = 'none';
        }
    }
    
    // Fonction pour obtenir le prix actuel selon les options sélectionnées
    function getCurrentPrice() {
        const selectedColor = document.querySelector('input[name="color"]:checked');
        const selectedSize = document.querySelector('input[name="size"]:checked');
        
        const colorValue = selectedColor ? selectedColor.value : null;
        const sizeValue = selectedSize ? selectedSize.value : null;
        
        console.log('=== DEBUG PRIX ===');
        console.log('Options sélectionnées:', { color: colorValue, size: sizeValue });
        console.log('Combinaisons disponibles:', priceCombinations);
        console.log('Prix de base:', basePrice);
        
        // Trouver toutes les combinaisons qui correspondent
        const matchingCombinations = [];
        
        for (const combination of priceCombinations) {
            console.log('Test combinaison:', combination);
            
            // Vérification : une combinaison correspond si :
            // - Elle n'a pas de couleur spécifiée OU la couleur correspond exactement
            // - Elle n'a pas de taille spécifiée OU la taille correspond exactement
            
            const colorMatches = !combination.color || combination.color === colorValue;
            const sizeMatches = !combination.size || combination.size === sizeValue;
            
            console.log(`Couleur : '${combination.color}' vs '${colorValue}' => ${colorMatches}`);
            console.log(`Taille : '${combination.size}' vs '${sizeValue}' => ${sizeMatches}`);
            
            if (colorMatches && sizeMatches) {
                // Calculer le score de spécificité (plus il y a de critères spécifiés, plus c'est spécifique)
                const specificity = (combination.color ? 1 : 0) + (combination.size ? 1 : 0);
                console.log(`✅ Combinaison correspond! Spécificité: ${specificity}, Prix: ${combination.price}`);
                
                matchingCombinations.push({
                    ...combination,
                    specificity: specificity
                });
            }
        }
        
        // S'il y a des combinaisons qui correspondent, prendre la plus spécifique
        if (matchingCombinations.length > 0) {
            // Trier par spécificité décroissante (plus spécifique d'abord)
            matchingCombinations.sort((a, b) => b.specificity - a.specificity);
            
            const selectedCombination = matchingCombinations[0];
            console.log('🎯 Combinaison sélectionnée (la plus spécifique):', selectedCombination);
            console.log('✅ Prix final:', selectedCombination.price);
            
            return parseFloat(selectedCombination.price);
        }
        
        // Aucune combinaison trouvée, utiliser le prix de base
        console.log('❌ Aucune combinaison trouvée, prix de base:', basePrice);
        return basePrice;
    }
    
    // Fonction pour formater les nombres avec séparateur de milliers
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    
    // Écouter les changements d'options qui affectent le prix
    const optionSelectors = document.querySelectorAll('.option-selector');
    console.log('=== INITIALISATION EVENT LISTENERS ===');
    console.log('Nombre de sélecteurs trouvés:', optionSelectors.length);
    
    optionSelectors.forEach((option, index) => {
        console.log(`Sélecteur ${index + 1}:`, option.name, option.value);
        option.addEventListener('change', function() {
            console.log('=== CHANGEMENT DÉTECTÉ ===');
            console.log('Option changée:', this.name, '=', this.value);
            updateDisplayPrice();
            updateFormOptions(); // Mettre à jour les champs cachés du formulaire
        });
    });
    
    // Fonction pour mettre à jour les champs cachés du formulaire
    function updateFormOptions() {
        const selectedColor = document.querySelector('input[name="color"]:checked');
        const selectedSize = document.querySelector('input[name="size"]:checked');
        
        const options = {};
        
        if (selectedColor) {
            options.color = selectedColor.value;
        }
        
        if (selectedSize) {
            options.size = selectedSize.value;
        }
        
        // Mettre à jour le champ options caché
        const optionsInput = document.getElementById('options-input');
        if (optionsInput) {
            optionsInput.value = JSON.stringify(options);
        }
        
        // Pour le prix, nous n'utilisons plus price_modifier, 
        // le backend calculera automatiquement selon les combinaisons
        const priceModifierInput = document.getElementById('price-modifier-input');
        if (priceModifierInput) {
            priceModifierInput.value = '0'; // Plus nécessaire, mais on le garde pour compatibilité
        }
    }
    
    // Mettre à jour le prix initial
    updateDisplayPrice();
    
    // Mettre à jour les options du formulaire initial
    updateFormOptions();
    
    // Thumbnail image selection et galerie d'images
    const thumbnails = document.querySelectorAll('.thumbnail-images img');
    const mainImage = document.querySelector('.main-image');
    const allImages = {{ product.images|default([])|tojson }};
    
    // Variables pour la pagination des images
    let currentImagePage = 0;
    const imagesPerPage = 4;
    const totalImages = allImages.length;
    const totalPages = Math.ceil(totalImages / imagesPerPage);
    
    // Gestion des clics sur les miniatures
    thumbnails.forEach((thumbnail, index) => {
        thumbnail.addEventListener('click', function() {
            // Remove active class from all thumbnails
            thumbnails.forEach(t => t.classList.remove('active'));
            
            // Add active class to clicked thumbnail
            this.classList.add('active');
            
            // Update main image source
            mainImage.src = this.src;
            
            // Ouvrir le modal en cliquant sur une miniature (optionnel)
            // openImageModal(parseInt(this.dataset.imageIndex));
        });
        
        // Double-clic pour ouvrir le modal
        thumbnail.addEventListener('dblclick', function() {
            openImageModal(parseInt(this.dataset.imageIndex));
        });
    });
    
    // Fonction pour afficher les images selon la page
    function displayImagesForPage(page) {
        const start = page * imagesPerPage;
        const end = start + imagesPerPage;
        
        // Masquer toutes les miniatures
        thumbnails.forEach(thumbnail => {
            thumbnail.parentElement.style.display = 'none';
        });
        
        // Afficher seulement les miniatures de la page actuelle
        for (let i = start; i < end && i < totalImages; i++) {
            if (thumbnails[i]) {
                thumbnails[i].parentElement.style.display = 'block';
            }
        }
        
        // Mettre à jour les compteurs
        const currentStart = document.getElementById('currentStart');
        const currentEnd = document.getElementById('currentEnd');
        
        if (currentStart && currentEnd) {
            currentStart.textContent = start + 1;
            currentEnd.textContent = Math.min(end, totalImages);
        }
        
        // Mettre à jour l'état des boutons
        const prevBtn = document.getElementById('prevImages');
        const nextBtn = document.getElementById('nextImages');
        
        if (prevBtn) prevBtn.disabled = page === 0;
        if (nextBtn) nextBtn.disabled = page >= totalPages - 1;
    }
    
    // Gestion de la navigation des images
    const prevImagesBtn = document.getElementById('prevImages');
    const nextImagesBtn = document.getElementById('nextImages');
    
    if (prevImagesBtn) {
        prevImagesBtn.addEventListener('click', function() {
            if (currentImagePage > 0) {
                currentImagePage--;
                displayImagesForPage(currentImagePage);
            }
        });
    }
    
    if (nextImagesBtn) {
        nextImagesBtn.addEventListener('click', function() {
            if (currentImagePage < totalPages - 1) {
                currentImagePage++;
                displayImagesForPage(currentImagePage);
            }
        });
    }
    
    // Gestion du modal d'images
    let currentModalImageIndex = 0;
    
    function openImageModal(imageIndex = 0) {
        currentModalImageIndex = imageIndex;
        updateModalImage();
        
        const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
        imageModal.show();
    }
    
    function updateModalImage() {
        const modalImage = document.getElementById('modalImage');
        const modalCurrent = document.getElementById('modalCurrent');
        const modalPrev = document.getElementById('modalPrev');
        const modalNext = document.getElementById('modalNext');
        
        if (modalImage && allImages[currentModalImageIndex]) {
            modalImage.src = allImages[currentModalImageIndex];
            modalCurrent.textContent = currentModalImageIndex + 1;
            
            modalPrev.disabled = currentModalImageIndex === 0;
            modalNext.disabled = currentModalImageIndex === allImages.length - 1;
        }
    }
    
    // Navigation dans le modal
    const modalPrevBtn = document.getElementById('modalPrev');
    const modalNextBtn = document.getElementById('modalNext');
    
    if (modalPrevBtn) {
        modalPrevBtn.addEventListener('click', function() {
            if (currentModalImageIndex > 0) {
                currentModalImageIndex--;
                updateModalImage();
            }
        });
    }
    
    if (modalNextBtn) {
        modalNextBtn.addEventListener('click', function() {
            if (currentModalImageIndex < allImages.length - 1) {
                currentModalImageIndex++;
                updateModalImage();
            }
        });
    }
    
    // Clic sur l'image principale pour ouvrir le modal
    if (mainImage) {
        mainImage.addEventListener('click', function() {
            const activeThumb = document.querySelector('.thumbnail-images img.active');
            const imageIndex = activeThumb ? parseInt(activeThumb.dataset.imageIndex) : 0;
            openImageModal(imageIndex);
        });
        
        // Ajouter un curseur pointer pour indiquer que l'image est cliquable
        mainImage.style.cursor = 'pointer';
        mainImage.title = 'Cliquez pour agrandir';
    }
    
    // Initialiser l'affichage des images au chargement
    if (totalImages > imagesPerPage) {
        displayImagesForPage(0);
    }
    
    // Star rating functionality
    const starInputs = document.querySelectorAll('.rating input');
    const starLabels = document.querySelectorAll('.rating label i');
    
    starInputs.forEach((input, index) => {
        input.addEventListener('change', function() {
            // Reset all stars
            starLabels.forEach(star => star.className = 'far fa-star');
            
            // Fill stars up to selected
            for (let i = 0; i <= index; i++) {
                starLabels[i].className = 'fas fa-star';
            }
        });
    });
    
    // SOLUTION SIMPLIFIÉE: GESTIONNAIRE BOUTONS QUANTITÉ
    const quantityInput = document.getElementById('quantity');
    const formQuantityInput = document.getElementById('form-quantity');
    const maxStock = {{ product.stock if product.stock else 99 }};
    
    // Fonction pour synchroniser les quantités et vérifier le stock
    function syncQuantity() {
        let quantity = parseInt(quantityInput.value) || 1;
        
        // S'assurer que la quantité ne dépasse pas le stock
        if (quantity > maxStock) {
            quantity = maxStock;
            quantityInput.value = quantity;
        }
        
        // S'assurer que la quantité est au minimum 1
        if (quantity < 1) {
            quantity = 1;
            quantityInput.value = quantity;
        }
        
        formQuantityInput.value = quantity;
        
        // Mettre à jour l'état des boutons
        updateButtonStates();
    }
    
    // Fonction pour mettre à jour l'état des boutons
    function updateButtonStates() {
        const currentValue = parseInt(quantityInput.value);
        const decreaseBtn = document.querySelector('.decrease-qty');
        const increaseBtn = document.querySelector('.increase-qty');
        
        // Désactiver le bouton moins si on est à 1
        decreaseBtn.disabled = currentValue <= 1;
        decreaseBtn.style.opacity = currentValue <= 1 ? '0.5' : '1';
        
        // Désactiver le bouton plus si on a atteint le stock maximum
        increaseBtn.disabled = currentValue >= maxStock;
        increaseBtn.style.opacity = currentValue >= maxStock ? '0.5' : '1';
        
        // Changer le curseur pour indiquer que le bouton n'est pas cliquable
        decreaseBtn.style.cursor = currentValue <= 1 ? 'not-allowed' : 'pointer';
        increaseBtn.style.cursor = currentValue >= maxStock ? 'not-allowed' : 'pointer';
    }
    
    document.querySelector('.decrease-qty').addEventListener('click', function() {
        const currentValue = parseInt(quantityInput.value);
        if (currentValue > 1) {
            quantityInput.value = currentValue - 1;
            syncQuantity();
        }
    });
    
    document.querySelector('.increase-qty').addEventListener('click', function() {
        const currentValue = parseInt(quantityInput.value);
        if (currentValue < maxStock) {
            quantityInput.value = currentValue + 1;
            syncQuantity();
        }
    });
    
    // Synchroniser lors du changement manuel de la quantité
    quantityInput.addEventListener('input', syncQuantity);
    quantityInput.addEventListener('change', syncQuantity);
    
    // Initialiser l'état des boutons au chargement
    updateButtonStates();
    
    // SOLUTION SIMPLIFIÉE: AJOUT AU PANIER - BOUTON PRINCIPAL
    const addToCartForm = document.getElementById('addToCartForm');
    if (addToCartForm) {
        addToCartForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Synchroniser la quantité avant la soumission
            syncQuantity();
            
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            // Collecter les options
            const options = {};
            
            // Couleur
            const colorInput = document.querySelector('input[name="color"]:checked');
            if (colorInput) options.color = colorInput.value;
            
            // Taille
            const sizeInput = document.querySelector('input[name="size"]:checked');
            if (sizeInput) options.size = sizeInput.value;
            
            // Stockage
            const storageInput = document.getElementById('storage-select');
            if (storageInput) options.storage = storageInput.value;
            
            // Autres options
            document.querySelectorAll('select[name^="option_"]').forEach(select => {
                options[select.name] = select.value;
            });
            
            // Mettre à jour l'input des options
            document.getElementById('options-input').value = JSON.stringify(options);
            
            // Ajouter au panier via fetch API
            fetch(`/add-to-cart/{{ product.id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `quantity=${quantity}&options=${encodeURIComponent(JSON.stringify(options))}`
            })
            .then(response => {
                if (!response.ok) throw new Error('Échec de la requête');
                return response.json();
            })
            .then(data => {
                console.log("Réponse du serveur:", data);
                
                if (data.success) {
                    // Animation du bouton
                    const submitBtn = this.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = '<i class="fas fa-check me-2"></i> Produit ajouté!';
                    submitBtn.classList.remove('btn-primary');
                    submitBtn.classList.add('btn-success');
                    
                    // Mise à jour des compteurs panier
                    if (typeof updateCartCountDisplay === 'function') {
                        updateCartCountDisplay(data.cart_count);
                    } else {
                        document.querySelectorAll('.cart-count').forEach(el => {
                            el.textContent = data.cart_count;
                            if (data.cart_count > 0) {
                                el.style.display = '';
                            } else {
                                el.style.display = 'none';
                            }
                        });
                    }
                    
                    // Notification
                    if (window.showCartNotification) {
                        showCartNotification(`${data.product_name || 'Produit'} ajouté au panier`);
                    }
                    
                    // Rétablir le bouton après 2s
                    setTimeout(() => {
                        submitBtn.innerHTML = '<i class="fas fa-cart-plus me-1"></i> Ajouter au panier';
                        submitBtn.classList.remove('btn-success');
                        submitBtn.classList.add('btn-primary');
                    }, 2000);
                }
            })
            .catch(error => {
                console.error("Erreur:", error);
                alert("Impossible d'ajouter le produit au panier. Veuillez réessayer.");
            });
        });
    }
    
    // SOLUTION SIMPLIFIÉE: BOUTONS PRODUITS SIMILAIRES
    document.querySelectorAll('.add-to-cart-related').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Récupérer l'ID du produit depuis l'attribut data
            const productId = this.getAttribute('data-product-id');
            
            // Ajouter au panier
            fetch(`/add-to-cart/${productId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: 'quantity=1'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Animation du bouton
                    this.innerHTML = '<i class="fas fa-check me-1"></i>Ajouté';
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-success');
                    
                    // Mise à jour des compteurs panier
                    if (typeof updateCartCountDisplay === 'function') {
                        updateCartCountDisplay(data.cart_count);
                    } else {
                        document.querySelectorAll('.cart-count').forEach(el => {
                            el.textContent = data.cart_count;
                            if (data.cart_count > 0) {
                                el.style.display = '';
                            } else {
                                el.style.display = 'none';
                            }
                        });
                    }
                    
                    // Notification
                    if (window.showCartNotification) {
                        showCartNotification(`Produit ajouté au panier`);
                    }
                    
                    // Rétablir le bouton après 1.5s
                    setTimeout(() => {
                        this.innerHTML = '<i class="fas fa-cart-plus me-1"></i>Ajouter au panier';
                        this.classList.remove('btn-success');
                        this.classList.add('btn-primary');
                    }, 1500);
                }
            })
            .catch(error => {
                console.error("Erreur lors de l'ajout au panier:", error);
            });
        });
    });
    
    // Gérer le bouton d'ajout aux favoris
    const wishlistButton = document.getElementById('addToWishlistBtn');
    if (wishlistButton) {
        wishlistButton.addEventListener('click', function() {
            // Animation du bouton
            const icon = this.querySelector('i');
            const isInWishlist = icon.classList.contains('fas');
            
            if (isInWishlist) {
                // Retirer des favoris
                icon.classList.remove('fas');
                icon.classList.add('far');
                this.classList.remove('btn-danger');
                this.classList.add('btn-outline-primary');
                
                showNotification('Produit retiré des favoris', 'info');
            } else {
                // Ajouter aux favoris
                icon.classList.remove('far');
                icon.classList.add('fas');
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-danger');
                
                showNotification('Produit ajouté aux favoris', 'success');
                
                // Animation de cœur
                const heart = document.createElement('div');
                heart.className = 'floating-heart';
                heart.innerHTML = '<i class="fas fa-heart"></i>';
                document.body.appendChild(heart);
                
                // Position de départ (bouton)
                const rect = this.getBoundingClientRect();
                heart.style.left = `${rect.left + rect.width/2}px`;
                heart.style.top = `${rect.top + rect.height/2}px`;
                
                // Animation
                setTimeout(() => {
                    heart.classList.add('animate');
                    setTimeout(() => {
                        document.body.removeChild(heart);
                    }, 1000);
                }, 10);
                
                // Dans une application réelle, envoyer une requête au serveur
                fetch('/api/wishlist/add/{{ product.id }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                }).catch(err => console.log('Simulation d\'ajout aux favoris'));
            }
        });
    }
    
    // Gérer le bouton de partage
    const shareButton = document.getElementById('shareProductBtn');
    if (shareButton) {
        shareButton.addEventListener('click', function() {
            // Vérifier si l'API de partage est disponible
            if (navigator.share) {
                navigator.share({
                    title: '{{ product.name }}',
                    text: '{{ product.description[:100] }}...',
                    url: window.location.href
                })
                .then(() => showNotification('Produit partagé avec succès!', 'success'))
                .catch(error => {
                    console.error('Erreur lors du partage:', error);
                    showShareDialog();
                });
            } else {
                // Fallback pour les navigateurs qui ne supportent pas l'API de partage
                showShareDialog();
            }
        });
    }
    
    // Fonction pour afficher une notification
    function showNotification(message, type = 'info') {
        // Utiliser la fonction de notification existante ou en créer une nouvelle
        if (window.showCartNotification) {
            window.showCartNotification(message, type);
        } else {
            // Créer une notification simple
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 2000);
            }, 10);
        }
    }
    
    // Fonction pour afficher une boîte de dialogue de partage personnalisée
    function showShareDialog() {
        // Créer la boîte de dialogue
        const dialog = document.createElement('div');
        dialog.className = 'share-dialog';
        dialog.innerHTML = `
            <div class="share-dialog-content">
                <div class="share-dialog-header">
                    <h5>Partager ce produit</h5>
                    <button class="btn-close" id="closeShareDialog"></button>
                </div>
                <div class="share-dialog-body">
                    <div class="share-options">
                        <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}" target="_blank" class="share-option facebook">
                            <i class="fab fa-facebook-f"></i>
                            <span>Facebook</span>
                        </a>
                        <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent('{{ product.name }}')}&url=${encodeURIComponent(window.location.href)}" target="_blank" class="share-option twitter">
                            <i class="fab fa-twitter"></i>
                            <span>Twitter</span>
                        </a>
                        <a href="https://wa.me/?text=${encodeURIComponent('{{ product.name }} - ' + window.location.href)}" target="_blank" class="share-option whatsapp">
                            <i class="fab fa-whatsapp"></i>
                            <span>WhatsApp</span>
                        </a>
                        <a href="mailto:?subject=${encodeURIComponent('{{ product.name }}')}&body=${encodeURIComponent('Découvrez ce produit: ' + window.location.href)}" class="share-option email">
                            <i class="fas fa-envelope"></i>
                            <span>Email</span>
                        </a>
                    </div>
                    <div class="mt-3">
                        <p class="mb-2">Ou copiez le lien:</p>
                        <div class="input-group">
                            <input type="text" id="shareUrl" class="form-control" value="${window.location.href}" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="copyShareLink">Copier</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Ajouter des styles CSS pour la boîte de dialogue
        const style = document.createElement('style');
        style.textContent = `
            .share-dialog {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1050;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.3s;
            }
            .share-dialog.show {
                opacity: 1;
                visibility: visible;
            }
            .share-dialog-content {
                background: white;
                border-radius: 8px;
                max-width: 90%;
                width: 400px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            }
            .share-dialog-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                border-bottom: 1px solid #eee;
            }
            .share-dialog-body {
                padding: 20px;
            }
            .share-options {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 15px;
            }
            .share-option {
                display: flex;
                align-items: center;
                padding: 10px 15px;
                border-radius: 5px;
                text-decoration: none;
                color: white;
                transition: opacity 0.2s;
            }
            .share-option:hover {
                opacity: 0.9;
            }
            .share-option i {
                margin-right: 10px;
                font-size: 18px;
            }
            .facebook { background: #3b5998; }
            .twitter { background: #1da1f2; }
            .whatsapp { background: #25d366; }
            .email { background: #dd4b39; }
            .toast-notification {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: white;
                color: #333;
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                padding: 15px 25px;
                border-radius: 4px;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.3s;
                z-index: 1060;
            }
            .toast-notification.show {
                opacity: 1;
                transform: translateY(0);
            }
            .toast-success {
                border-left: 4px solid #28a745;
            }
            .toast-info {
                border-left: 4px solid #17a2b8;
            }
            .toast-warning {
                border-left: 4px solid #ffc107;
            }
            .toast-error {
                border-left: 4px solid #dc3545;
            }
            .floating-heart {
                position: fixed;
                font-size: 24px;
                color: #dc3545;
                pointer-events: none;
                transform: translate(-50%, -50%);
                z-index: 1000;
            }
            .floating-heart.animate {
                animation: float-heart 1s ease-out forwards;
            }
            @keyframes float-heart {
                0% {
                    transform: translate(-50%, -50%) scale(1);
                    opacity: 1;
                }
                100% {
                    transform: translate(-50%, -100px) scale(2);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
        document.body.appendChild(dialog);
        
        // Afficher la boîte de dialogue
        setTimeout(() => dialog.classList.add('show'), 10);
        
        // Gérer la fermeture
        document.getElementById('closeShareDialog').addEventListener('click', () => {
            dialog.classList.remove('show');
            setTimeout(() => document.body.removeChild(dialog), 300);
        });
        
        // Gérer la copie du lien
        document.getElementById('copyShareLink').addEventListener('click', () => {
            const shareUrl = document.getElementById('shareUrl');
            shareUrl.select();
            document.execCommand('copy');
            
            const copyBtn = document.getElementById('copyShareLink');
            copyBtn.textContent = 'Copié!';
            copyBtn.classList.remove('btn-outline-secondary');
            copyBtn.classList.add('btn-success');
            
            setTimeout(() => {
                copyBtn.textContent = 'Copier';
                copyBtn.classList.remove('btn-success');
                copyBtn.classList.add('btn-outline-secondary');
            }, 1500);
        });
    }
    
    // Gestion des avis produits
    const reviewForm = document.getElementById('review-form');
    if (reviewForm) {
        // Gestion de l'interaction avec les étoiles
        const ratingInputs = document.querySelectorAll('input[name="rating"]');
        const ratingLabels = document.querySelectorAll('.rating label');
        
        ratingLabels.forEach((label, index) => {
            label.addEventListener('mouseenter', function() {
                // Surligner les étoiles jusqu'à celle survolée
                for (let i = 0; i <= index; i++) {
                    ratingLabels[i].querySelector('i').classList.remove('far');
                    ratingLabels[i].querySelector('i').classList.add('fas');
                }
                for (let i = index + 1; i < ratingLabels.length; i++) {
                    ratingLabels[i].querySelector('i').classList.remove('fas');
                    ratingLabels[i].querySelector('i').classList.add('far');
                }
            });
        });
        
        // Réinitialiser les étoiles quand on quitte la zone de notation
        document.querySelector('.rating').addEventListener('mouseleave', function() {
            const checkedRating = document.querySelector('input[name="rating"]:checked');
            const checkedValue = checkedRating ? parseInt(checkedRating.value) : 0;
            
            ratingLabels.forEach((label, index) => {
                if (index < checkedValue) {
                    label.querySelector('i').classList.remove('far');
                    label.querySelector('i').classList.add('fas');
                } else {
                    label.querySelector('i').classList.remove('fas');
                    label.querySelector('i').classList.add('far');
                }
            });
        });
        
        // Gestion de la soumission du formulaire d'avis
        reviewForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(reviewForm);
            const rating = formData.get('rating');
            
            if (!rating) {
                alert('Veuillez sélectionner une note avant de soumettre votre avis.');
                return;
            }
            
            // Désactiver le bouton de soumission
            const submitBtn = reviewForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Envoi en cours...';
            
            // Envoyer les données via AJAX
            fetch(reviewForm.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    product_id: formData.get('product_id'),
                    rating: parseInt(formData.get('rating')),
                    title: formData.get('title'),
                    comment: formData.get('comment')
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Afficher un message de succès
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    reviewForm.parentNode.insertBefore(alertDiv, reviewForm);
                    
                    // Réinitialiser le formulaire
                    reviewForm.reset();
                    
                    // Réinitialiser les étoiles
                    ratingLabels.forEach(label => {
                        label.querySelector('i').classList.remove('fas');
                        label.querySelector('i').classList.add('far');
                    });
                    
                    // Recharger la page après 2 secondes pour afficher le nouvel avis
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    throw new Error(data.message || 'Erreur lors de l\'envoi de l\'avis');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    ${error.message || 'Erreur lors de l\'envoi de l\'avis. Veuillez réessayer.'}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                reviewForm.parentNode.insertBefore(alertDiv, reviewForm);
            })
            .finally(() => {
                // Réactiver le bouton
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        });
    }
    
    // Gérer les formulaires wishlist avec AJAX
    const wishlistForms = document.querySelectorAll('.wishlist-form');
    wishlistForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault(); // Empêcher le rechargement de la page
            
            const button = this.querySelector('button[type="submit"]');
            const icon = button.querySelector('i');
            const isAddToWishlist = button.classList.contains('add-to-wishlist');
            
            // Désactiver le bouton pendant la requête
            button.disabled = true;
            
            // Préparer les données du formulaire
            const formData = new FormData(this);
            
            // Envoyer la requête AJAX
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mettre à jour l'apparence du bouton
                    if (isAddToWishlist) {
                        // Convertir en bouton "retirer de la wishlist"
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                        button.classList.remove('btn-outline-secondary', 'add-to-wishlist');
                        button.classList.add('btn-outline-danger', 'already-in-wishlist');
                        button.setAttribute('title', 'Retirer de ma liste d\'envies');
                        
                        // Changer l'action du formulaire
                        this.action = this.action.replace('/add-to-wishlist/', '/remove-from-wishlist/');
                        
                        showNotification('Produit ajouté à votre liste d\'envies!', 'success');
                    } else {
                        // Convertir en bouton "ajouter à la wishlist"
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                        button.classList.remove('btn-outline-danger', 'already-in-wishlist');
                        button.classList.add('btn-outline-secondary', 'add-to-wishlist');
                        button.setAttribute('title', 'Ajouter à ma liste d\'envies');
                        
                        // Changer l'action du formulaire
                        this.action = this.action.replace('/remove-from-wishlist/', '/add-to-wishlist/');
                        
                        showNotification('Produit retiré de votre liste d\'envies', 'info');
                    }
                } else {
                    showNotification(data.message || 'Une erreur est survenue', 'error');
                }
            })
            .catch(error => {
                console.error('Erreur wishlist:', error);
                showNotification('Erreur de connexion', 'error');
            })
            .finally(() => {
                // Réactiver le bouton
                button.disabled = false;
            });
        });
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Styles pour les boutons d'action */
    .product-image-container {
        position: relative;
    }
    
    .thumbnail-images .img-thumbnail {
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
    }
    
    .thumbnail-images .img-thumbnail.active {
        border-color: #0d6efd;
    }
    
    /* Styles pour la galerie d'images dynamique */
    .image-gallery-container {
        width: 100%;
    }
    
    .gallery-navigation {
        margin-top: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .gallery-counter {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    .thumbnail-images {
        max-height: none;
        overflow: visible;
    }
    
    .thumbnail-images .col-3,
    .thumbnail-images .col-md-2,
    .thumbnail-images .col-lg-3 {
        transition: all 0.3s ease;
    }
    
    .thumbnail-images img {
        width: 100%;
        height: 80px;
        object-fit: cover;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    .thumbnail-images img:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    /* Modal pour les images agrandies */
    #imageModal .modal-dialog {
        max-width: 90%;
    }
    
    #modalImage {
        max-height: 70vh;
        object-fit: contain;
        cursor: zoom-in;
    }
    
    .modal-counter {
        font-size: 1rem;
        color: #6c757d;
        font-weight: 500;
        padding: 0 15px;
    }
    
    /* Indicateur cliquable sur l'image principale */
    .main-image {
        transition: transform 0.2s ease;
        border-radius: 8px;
    }
    
    .main-image:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    /* Badge "Voir toutes" pour indiquer qu'il y a plus d'images */
    .more-images-badge {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .more-images-badge:hover {
        background: rgba(0,0,0,0.9);
        transform: scale(1.05);
    }
    
    /* Responsive pour la galerie */
    @media (max-width: 768px) {
        .thumbnail-images img {
            height: 60px;
        }
        
        .gallery-navigation {
            padding: 8px;
            margin-top: 10px;
        }
        
        .gallery-counter {
            font-size: 0.8rem;
        }
        
        #imageModal .modal-dialog {
            max-width: 95%;
        }
        
        #modalImage {
            max-height: 60vh;
        }
    }
    
    @media (max-width: 576px) {
        .thumbnail-images {
            margin: 0 -5px;
        }
        
        .thumbnail-images .col-3 {
            padding: 0 5px;
        }
        
        .thumbnail-images img {
            height: 50px;
            border-radius: 4px;
        }
        
        .gallery-navigation .btn-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .gallery-counter {
            font-size: 0.75rem;
        }
    }
    
    /* Animation pour l'apparition des nouvelles images */
    .thumbnail-images .col-3,
    .thumbnail-images .col-md-2,
    .thumbnail-images .col-lg-3 {
        opacity: 1;
        transform: translateY(0);
    }
    
    .thumbnail-images .col-3.fade-in,
    .thumbnail-images .col-md-2.fade-in,
    .thumbnail-images .col-lg-3.fade-in {
        animation: fadeInUp 0.3s ease-out;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Loader pour le chargement des images */
    .image-loading {
        position: relative;
        overflow: hidden;
    }
    
    .image-loading::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
        animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    /* Styles pour le système d'évaluation */
    .rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
    }
    
    .rating input {
        display: none;
    }
    
    .rating label {
        cursor: pointer;
        font-size: 25px;
        color: #ddd;
        margin-right: 5px;
    }
    
    .rating input:checked ~ label,
    .rating label:hover,
    .rating label:hover ~ label {
        color: #ffc107;
    }
    
    /* Styles pour les options de couleur */
    .color-circle {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        border: 1px solid #ddd;
    }
    
    /* Styles pour les variants de produits */
    .variant-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .variant-option {
        border: 1px solid #ddd;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .variant-option.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
    
    /* Style amélioré pour les boutons wishlist */
    .already-in-wishlist {
        background-color: #ffeaea;
        border-color: #dc3545;
        color: #dc3545;
        width: 50px;
        min-width: 50px;
        height: 38px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .already-in-wishlist:hover {
        background-color: #dc3545;
        color: white;
    }
    
    .add-to-wishlist {
        width: 50px;
        min-width: 50px;
        height: 38px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.2s ease;
        background-color: #f8f9fa;
        color: #6c757d;
        border-radius: 4px;
    }
    
    .add-to-wishlist:hover {
        background-color: #f8f9fa;
        color: #dc3545;
        border-color: #dc3545;
    }
    
    .wishlist-btn-container {
        width: auto;
        margin-left: 10px;
    }
    
    /* S'assurer que le bouton d'ajout au panier a la bonne largeur */
    #addToCartBtn {
        flex: 1;
    }
    
    /* Styles pour les produits similaires */
    .related-product-card {
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
    }
    
    .related-product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        border-color: #0d6efd;
    }
    
    .card-img-container {
        position: relative;
        height: 200px;
        overflow: hidden;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 1px solid #e9ecef;
    }
    
    .related-product-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        object-position: center;
        transition: transform 0.3s ease;
        background-color: transparent;
        padding: 8px;
        box-sizing: border-box;
    }
    
    .related-product-card:hover .related-product-img {
        transform: scale(1.05);
    }
    
    .card-title {
        font-size: 0.95rem;
        line-height: 1.4;
        height: 2.8rem;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
    }
    
    .price-container {
        min-height: 1.5rem;
    }
    
    /* Badge styles */
    .badge {
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .card-img-container {
            height: 160px;
        }
        
        .card-title {
            font-size: 0.85rem;
            height: 2.4rem;
            line-height: 1.3;
        }
        
        /* Ajustements pour 2 colonnes sur mobile */
        .related-product-card {
            margin-bottom: 1rem;
        }
        
        .related-product-card .card-body {
            padding: 0.75rem;
        }
        
        .price-container {
            min-height: 1.3rem;
        }
        
        .btn-sm {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
    }
    
    @media (max-width: 576px) {
        .card-img-container {
            height: 140px;
        }
        
        .card-title {
            font-size: 0.8rem;
            height: 2.2rem;
            line-height: 1.2;
        }
        
        .related-product-card {
            border-radius: 8px;
        }
        
        .related-product-card .card-body {
            padding: 0.6rem;
        }
        
        /* Optimisation pour très petits écrans mais gardant 2 colonnes */
        .g-4 {
            --bs-gutter-x: 0.75rem;
            --bs-gutter-y: 0.75rem;
        }
        
        .btn-sm {
            font-size: 0.75rem;
            padding: 0.35rem 0.6rem;
        }
        
        /* Effet de survol désactivé sur mobile pour de meilleures performances */
        .related-product-card:hover {
            transform: none;
        }
        
        .related-product-card:hover .related-product-img {
            transform: none;
        }
    }
    
    /* Section heading style */
    .section-heading {
        color: #2c3e50;
        border-bottom: 3px solid #0d6efd;
        padding-bottom: 10px;
        margin-bottom: 30px;
        font-weight: 600;
    }
    
    .section-heading small {
        color: #6c757d;
        font-weight: 400;
    }
    
    /* Animation pour les boutons d'ajout au panier */
    .add-to-cart-related {
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .add-to-cart-related:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
    }
    
    /* Style pour la page vide */
    .text-center.py-5 {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        border: 2px dashed #dee2e6;
    }
</style>
{% endblock %}

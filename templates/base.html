<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}DOUKA KM - Commerce en ligne aux Comores{% endblock %}</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="{% block description %}DOUKA KM - La première plateforme de commerce en ligne aux Comores. Découvrez des milliers de produits de qualité livrés directement chez vous.{% endblock %}">
    <meta name="keywords" content="{% block keywords %}commerce, en ligne, Comores, livraison, produits, achat, vente, Grande Comore, Anjouan, Mohéli{% endblock %}">
    <meta name="author" content="DOUKA KM">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="{% block canonical %}{{ request.url }}{% endblock %}">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:url" content="{% block og_url %}{{ request.url }}{% endblock %}">
    <meta property="og:title" content="{% block og_title %}DOUKA KM - Commerce en ligne aux Comores{% endblock %}">
    <meta property="og:description" content="{% block og_description %}La première plateforme de commerce en ligne aux Comores. Découvrez des milliers de produits de qualité livrés directement chez vous.{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{{ url_for('static', filename='img/logo.svg', _external=True) }}{% endblock %}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="DOUKA KM">
    <meta property="og:locale" content="fr_KM">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{% block twitter_url %}{{ request.url }}{% endblock %}">
    <meta property="twitter:title" content="{% block twitter_title %}DOUKA KM - Commerce en ligne aux Comores{% endblock %}">
    <meta property="twitter:description" content="{% block twitter_description %}La première plateforme de commerce en ligne aux Comores. Découvrez des milliers de produits de qualité livrés directement chez vous.{% endblock %}">
    <meta property="twitter:image" content="{% block twitter_image %}{{ url_for('static', filename='img/logo.svg', _external=True) }}{% endblock %}">
    
    <!-- JSON-LD Schema.org pour Google -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "DOUKA KM",
      "alternateName": "DOUKA",
      "url": "{{ url_for('home', _external=True) }}",
      "logo": "{{ url_for('static', filename='img/logo.svg', _external=True) }}",
      "description": "La première plateforme de commerce en ligne aux Comores",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Moroni",
        "addressRegion": "Grande Comore",
        "addressCountry": "KM"
      },
      "contactPoint": {
        "@type": "ContactPoint",
        "telephone": "+269-342-40-19",
        "contactType": "Customer Service",
        "email": "ledouka.km@gmail.com"
      },
      "sameAs": [
        "https://www.facebook.com/doukakm",
        "https://www.instagram.com/doukakm"
      ]
    }
    </script>
    
    <!-- Schema.org pour WebSite -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "DOUKA KM",
      "url": "{{ url_for('home', _external=True) }}",
      "description": "Commerce en ligne aux Comores",
      "potentialAction": {
        "@type": "SearchAction",
        "target": {
          "@type": "EntryPoint",
          "urlTemplate": "{{ url_for('products', _external=True) }}?search={search_term_string}"
        },
        "query-input": "required name=search_term_string"
      }
    }
    </script>
    
    {% block extra_schemas %}{% endblock %}
    
    <!-- Ajout du favicon -->
    <link rel="icon" href="{{ url_for('static', filename='img/logo.svg') }}" type="image/png">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon.ico') }}" type="image/x-icon">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/logo.svg') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='img/logo.svg') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='img/logo.svg') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='img/logo.svg') }}">
    
    <!-- Manifest pour PWA -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#0d6efd">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/products.css') }}">
    {% block extra_css %}{% endblock %}
    <style>
        /* Styles pour le menu mobile slide-in */
        .offcanvas-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background: #fff;
            z-index: 2000;
            transition: left 0.3s ease;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            overflow-y: auto;
        }
        
        .offcanvas-menu.active {
            left: 0;
        }
        
        .offcanvas-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--primary-color);
            color: white;
        }
        
        .offcanvas-body {
            padding: 0;
        }
        
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }
        
        .mobile-menu-overlay.active {
            display: block;
        }
        
        .offcanvas-menu .navbar-nav {
            padding: 0;
        }
        
        .offcanvas-menu .nav-item {
            border-bottom: 1px solid #eee;
        }
        
        .offcanvas-menu .nav-link {
            padding: 15px;
            display: flex;
            align-items: center;
            color: #333;
        }
        
        .offcanvas-menu .nav-link i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }
        
        .offcanvas-menu .btn {
            margin: 15px;
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <button class="navbar-toggler me-2" type="button" id="mobile-menu-btn">
                    <span class="navbar-toggler-icon"></span>
                </button>
                                <a class="navbar-brand d-flex align-items-center" href="/">
                    <!-- Utiliser toujours url_for pour la compatibilité avec Render.com -->
                    <img src="{{ url_for('static', filename='img/logo.svg') }}" 
                         alt="{{ site_settings.logo_alt_text or site_settings.site_name or 'DOUKA KM' }}" 
                         class="me-2 navbar-logo" 
                         style="max-height: 40px; max-width: 150px;" 
                         onerror="handleNavbarLogoError(this);">
                    <span class="navbar-text fw-bold">{{ site_settings.site_name or 'DOUKA KM' }}</span>
                </a>
                <button class="navbar-toggler d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" style="visibility: hidden;">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="fas fa-home"></i> Accueil
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/products">
                                <i class="fas fa-box"></i> Produits
                            </a>
                        </li>
                    <!--
                        <li class="nav-item">
                            <a class="nav-link" href="/about">
                                <i class="fas fa-info-circle"></i> À propos
                            </a>
                        </li>
                    -->
                        <li class="nav-item">
                            <a class="nav-link" href="/contact">
                                <i class="fas fa-envelope"></i> Contact
                            </a>
                        </li>
                    </ul>
                    <div class="d-flex">
                        <!-- Dans la section du panier dans la barre de navigation -->
<a href="/cart" class="btn btn-outline-light me-2 position-relative">
    <i class="fas fa-shopping-cart"></i> Panier 
    <span class="cart-count position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="{% if cart_count == 0 %}display: none;{% endif %}">
        {{ cart_count }}
    </span>
</a>

    {% if user %}
        <div class="dropdown">
            <button class="btn btn-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-user-circle me-1"></i> {{ user.first_name }}
            </button>
            <!-- Modifier les liens du menu utilisateur dans la barre de navigation -->
<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
    <li><a class="dropdown-item" href="{{ url_for('profile') }}"><i class="fas fa-user me-2"></i>Mon profil</a></li>
    <li><a class="dropdown-item" href="{{ url_for('orders') }}"><i class="fas fa-box me-2"></i>Mes commandes</a></li>
    <li><a class="dropdown-item" href="{{ url_for('wishlist') }}"><i class="fas fa-heart me-2"></i>Ma liste d'envies</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt me-2"></i>Déconnexion</a></li>
</ul>
        </div>
    {% else %}
        <a href="{{ url_for('login') }}" class="btn btn-light me-2">Connexion</a>
        <a href="{{ url_for('register') }}" class="btn btn-outline-light">Inscription</a>
    {% endif %}
</div>
                </div>
            </div>
        </nav>
        
        <!-- Mobile Menu (slides from left) -->
        <div class="mobile-menu-overlay" id="menu-overlay"></div>
        <div class="offcanvas-menu" id="mobile-menu">
            <div class="offcanvas-header">
                <h5 class="mb-0">Menu</h5>
                <button type="button" class="btn-close btn-close-white" id="close-mobile-menu"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home"></i> Accueil
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/products">
                            <i class="fas fa-box"></i> Produits
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/about">
                            <i class="fas fa-info-circle"></i> À propos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/contact">
                            <i class="fas fa-envelope"></i> Contact
                        </a>
                    </li>
                </ul>
                <a href="/cart" class="btn btn-outline-primary d-block position-relative">
                    <i class="fas fa-shopping-cart"></i> Panier
                    <span class="cart-count badge bg-danger ms-1" style="{% if cart_count == 0 %}display: none;{% endif %}">{{ cart_count }}</span>
                </a>
                
                <div class="mt-3">
                {% if user %}
                    <div class="text-center mb-3">
                        <span class="d-block mb-2">Connecté en tant que</span>
                        <span class="fw-bold">{{ user.first_name }} {{ user.last_name }}</span>
                    </div>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('profile') }}" class="btn btn-outline-primary">Mon profil</a>
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">Déconnexion</a>
                    </div>
                {% else %}
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('login') }}" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt me-2"></i> Connexion
                        </a>
                        <a href="{{ url_for('register') }}" class="btn btn-outline-primary">
                            <i class="fas fa-user-plus me-2"></i> Créer un compte
                        </a>
                    </div>
                {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Barre de catégories dynamique optimisée pour l'affichage horizontal et les sous-menus -->
        <div class="category-nav py-2 bg-light border-bottom">
            <div class="container position-relative">
                <div class="category-wrapper">
                    <ul class="category-list">
                        {% if categories_with_subcategories %}
                            {% for category in categories_with_subcategories %}
                                <li class="category-item">
                                    <a href="/products?category_filter={{ category.id }}" class="category-link">
                                        {% if category.icon %}
                                            <i class="{{ category.icon }}"></i>
                                        {% else %}
                                            <!-- Icônes par défaut selon le nom de la catégorie -->
                                            {% if 'électronique' in category.name.lower() or 'electronique' in category.name.lower() or 'tech' in category.name.lower() %}
                                                <i class="fas fa-mobile-alt"></i>
                                            {% elif 'vêtement' in category.name.lower() or 'vetement' in category.name.lower() or 'mode' in category.name.lower() %}
                                                <i class="fas fa-tshirt"></i>
                                            {% elif 'alimentation' in category.name.lower() or 'nourriture' in category.name.lower() or 'food' in category.name.lower() %}
                                                <i class="fas fa-utensils"></i>
                                            {% elif 'artisanat' in category.name.lower() or 'art' in category.name.lower() %}
                                                <i class="fas fa-paint-brush"></i>
                                            {% elif 'maison' in category.name.lower() or 'déco' in category.name.lower() or 'deco' in category.name.lower() %}
                                                <i class="fas fa-home"></i>
                                            {% elif 'santé' in category.name.lower() or 'sante' in category.name.lower() or 'beauté' in category.name.lower() or 'beaute' in category.name.lower() %}
                                                <i class="fas fa-spa"></i>
                                            {% elif 'livre' in category.name.lower() or 'éducation' in category.name.lower() or 'education' in category.name.lower() %}
                                                <i class="fas fa-book"></i>
                                            {% elif 'sport' in category.name.lower() or 'fitness' in category.name.lower() %}
                                                <i class="fas fa-dumbbell"></i>
                                            {% elif 'auto' in category.name.lower() or 'voiture' in category.name.lower() %}
                                                <i class="fas fa-car"></i>
                                            {% elif 'enfant' in category.name.lower() or 'bébé' in category.name.lower() or 'bebe' in category.name.lower() or 'jouet' in category.name.lower() %}
                                                <i class="fas fa-baby"></i>
                                            {% else %}
                                                <i class="fas fa-tag"></i>
                                            {% endif %}
                                        {% endif %}
                                        {{ category.name }}
                                    </a>
                                    
                                    {% if category.subcategories %}
                                        <div class="subcategory-menu">
                                            <div class="subcategory-header">
                                                <h5>{{ category.name }}</h5>
                                                {% if category.description %}
                                                    <p>{{ category.description }}</p>
                                                {% else %}
                                                    <p>Découvrez notre sélection {{ category.name.lower() }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="subcategory-content">
                                                <div class="row">
                                                    {% set subcategories_per_column = ((category.subcategories|length) / 3)|round(0, 'ceil')|int %}
                                                    {% for chunk in category.subcategories|batch(subcategories_per_column) %}
                                                        <div class="col-md-4">
                                                            <div class="subcategory-group">
                                                                <h6>
                                                                    {% if category.icon %}
                                                                        <i class="{{ category.icon }}"></i>
                                                                    {% else %}
                                                                        <i class="fas fa-list"></i>
                                                                    {% endif %}
                                                                    Sous-catégories
                                                                </h6>
                                                                <ul>
                                                                    {% for subcategory in chunk %}
                                                                        <li>
                                                                            <a href="/products?category_filter={{ category.id }}&subcategory_filter={{ subcategory.id }}">
                                                                                {{ subcategory.name }}
                                                                            </a>
                                                                        </li>
                                                                    {% endfor %}
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                    
                                                    <!-- Si moins de 3 colonnes, remplir avec des suggestions -->
                                                    {% if category.subcategories|length < 6 %}
                                                        <div class="col-md-4">
                                                            <div class="subcategory-group">
                                                                <h6><i class="fas fa-star"></i> Populaires</h6>
                                                                <ul>
                                                                    <li><a href="/products?category_filter={{ category.id }}&sort=popular">Produits populaires</a></li>
                                                                    <li><a href="/products?category_filter={{ category.id }}&sort=recent">Nouveautés</a></li>
                                                                    <li><a href="/products?category_filter={{ category.id }}&sort=price_asc">Prix croissant</a></li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="subcategory-footer">
                                                    <a href="/products?category_filter={{ category.id }}" class="btn btn-sm btn-primary">
                                                        Voir tous les produits {{ category.name.lower() }}
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        {% else %}
                            <!-- Fallback si aucune catégorie dynamique n'est disponible -->
                            <li class="category-item">
                                <a href="/products" class="category-link">
                                    <i class="fas fa-th-large"></i> Tous les produits
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <main class="container py-4">
        {% block content %}{% endblock %}
    </main>

    <footer class="footer-section">
        <!-- Newsletter Section -->
        <!-- Main Footer -->
        <div class="main-footer bg-dark text-white py-5">
            <div class="container">
                                <div class="row justify-content-center g-4">
                    <!-- Company Info à gauche -->
                    <div class="col-md-6 mb-4">
                        <div class="footer-widget">
                            <div class="footer-logo mb-3">
                                <!-- Logo avec plusieurs fallbacks pour Render.com -->
                                <img id="footer-logo" 
                                     src="{{ url_for('static', filename='img/logo.svg') }}" 
                                     alt="{{ site_settings.logo_alt_text or site_settings.site_name or 'DOUKA KM' }}" 
                                     class="img-fluid" 
                                     style="max-height: 50px;"
                                     onerror="handleFooterLogoError(this);">
                                <h5 class="mt-2 text-warning">{{ site_settings.site_name or 'DOUKA KM' }}</h5>
                            </div>
                            <p class="text-light">{{ site_settings.site_description or 'La première plateforme de commerce aux Comores. Connectant acheteurs et vendeurs à travers l\'archipel.' }}</p>
                            <div class="social-links mt-3">
                                <a href="#" class="social-link me-2" title="Facebook">
                                    <i class="fab fa-facebook-f"></i>
                                </a>
                                <a href="#" class="social-link me-2" title="Instagram">
                                    <i class="fab fa-instagram"></i>
                                </a>
                                <a href="#" class="social-link me-2" title="Twitter">
                                    <i class="fab fa-twitter"></i>
                                </a>
                                <a href="#" class="social-link me-2" title="WhatsApp">
                                    <i class="fab fa-whatsapp"></i>
                                </a>
                                <a href="#" class="social-link" title="LinkedIn">
                                    <i class="fab fa-linkedin-in"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                    
                    <!-- Contact Info à droite -->
                    <div class="col-md-6 mb-4">
                        <div class="footer-widget">
                            <h6 class="footer-title text-warning mb-3">Contactez-nous</h6>
                            <div class="contact-info">
                                <div class="contact-item mb-3">
                                    <i class="fas fa-map-marker-alt text-warning me-2"></i>
                                    <span>Moroni, Grande Comore<br>Union des Comores</span>
                                </div>
                                <div class="contact-item mb-3">
                                    <i class="fas fa-phone text-warning me-2"></i>
                                    <span>+269 342 40 19</span>
                                </div>
                                <div class="contact-item mb-3">
                                    <i class="fas fa-envelope text-warning me-2"></i>
                                    <span>ledouka.km@gmail.com</span>
                                </div>
                                <div class="contact-item mb-3">
                                    <i class="fas fa-clock text-warning me-2"></i>
                                    <span>Lun - Sam: 8h00 - 18h00<br>Dimanche: 10h00 - 16h00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Methods & Guarantees -->
                <div class="row mt-4 pt-4 border-top border-secondary">
                    <div class="col-md-6 mb-3">
                        <h6 class="text-warning mb-3">Méthodes de paiement</h6>
                        <div class="payment-methods">
                            <img src="{{ url_for('static', filename='img/visa.png') }}" alt="Visa" class="payment-icon me-2">
                            <img src="{{ url_for('static', filename='img/mastercard.png') }}" alt="Mastercard" class="payment-icon me-2">
                            <img src="{{ url_for('static', filename='img/mvola.png') }}" alt="Mvola" class="payment-icon me-2">
                            <img src="{{ url_for('static', filename='img/holo.png') }}" alt="Holo" class="payment-icon me-2">
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6 class="text-warning mb-3">Nos garanties</h6>
                        <div class="guarantees">
                            <span class="badge bg-outline-warning me-2 mb-2">
                                <i class="fas fa-shield-alt me-1"></i>Paiement sécurisé
                            </span>
                            <span class="badge bg-outline-warning me-2 mb-2">
                                <i class="fas fa-truck me-1"></i>Livraison gratuite +50.000 KMF
                            </span>
                            <span class="badge bg-outline-warning me-2 mb-2">
                                <i class="fas fa-undo me-1"></i>Retour 14 jours
                            </span>
                            <span class="badge bg-outline-warning me-2 mb-2">
                                <i class="fas fa-headset me-1"></i>Support 24/7
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Footer -->
        <div class="bottom-footer bg-dark py-3" style="border-top: 1px solid #495057;">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="mb-0 text-light">
                            &copy; 2025 DOUKA KM. Tous droits réservés. 
                            <span class="text-warning">Made with <i class="fas fa-heart text-danger"></i> in Comoros</span>
                        </p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="footer-legal">
                            <a href="{{ url_for('privacy_policy') }}" class="footer-link me-3">Politique de confidentialité</a>
                            <a href="{{ url_for('terms_of_service') }}" class="footer-link me-3">Conditions d'utilisation</a>
                            <a href="{{ url_for('legal_notice') }}" class="footer-link">Mentions légales</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Toast notification system for cart actions -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="cartToast" class="toast clickable-toast" role="alert" aria-live="assertive" aria-atomic="true" 
             style="cursor: pointer;" title="Cliquez pour aller au panier"
             onclick="handleToastClick(event)">
            <div class="toast-header bg-primary text-white">
                <i class="fas fa-shopping-cart me-2"></i>
                <strong class="me-auto">Panier</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close" onclick="event.stopPropagation();"></button>
            </div>
            <div class="toast-body">
                Produit ajouté au panier avec succès
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        // Mobile menu slide functionality
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            const menuOverlay = document.getElementById('menu-overlay');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const closeMenuBtn = document.getElementById('close-mobile-menu');
            const mobileMenuLinks = document.querySelectorAll('#mobile-menu .nav-link, #mobile-menu .btn');
            
            // Fonction pour ouvrir le menu
            function openMenu() {
                mobileMenu.classList.add('active');
                menuOverlay.classList.add('active');
                document.body.style.overflow = 'hidden'; // Empêche le défilement du body
            }
            
            // Fonction pour fermer le menu
            function closeMenu() {
                mobileMenu.classList.remove('active');
                menuOverlay.classList.remove('active');
                document.body.style.overflow = ''; // Rétablit le défilement
            }
            
            // Ouvrir le menu au clic sur le bouton hamburger
            mobileMenuBtn.addEventListener('click', openMenu);
            
            // Fermer le menu au clic sur le bouton de fermeture
            closeMenuBtn.addEventListener('click', closeMenu);
            
            // Fermer le menu au clic sur l'overlay
            menuOverlay.addEventListener('click', closeMenu);
            
            // Fermer le menu après clic sur un lien
            mobileMenuLinks.forEach(link => {
                link.addEventListener('click', closeMenu);
            });
            
            // Fermer le menu si l'écran est redimensionné vers une largeur desktop
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 992) {
                    closeMenu();
                }
            });
        });
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
    // Script immédiat pour résoudre le problème des catégories sur mobile
    document.addEventListener('DOMContentLoaded', function() {
        // Correction pour les liens de catégories sur mobile
        if (window.innerWidth <= 991) {
            document.querySelectorAll('.category-link').forEach(function(link) {
                // S'assurer que les liens fonctionnent
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    if (href && href !== '#') {
                        window.location.href = href;
                    }
                }, true);
            });
        }
    });
    </script>
    <script>
// Fonction pour gérer le clic sur le toast
function handleToastClick(event) {
    console.log('Toast cliqué!', event.target);
    
    // Empêcher la fermeture si on clique sur le bouton close
    if (event.target.classList.contains('btn-close') || event.target.closest('.btn-close')) {
        console.log('Clic sur bouton fermer - pas de redirection');
        return;
    }
    
    console.log('Redirection vers le panier...');
    // Rediriger vers le panier
    window.location.href = '/cart';
}

// Fonction pour afficher une notification toast
function showCartNotification(message, type = 'success') {
    const toast = document.getElementById('cartToast');
    if (toast) {
        const toastBody = toast.querySelector('.toast-body');
        const toastHeader = toast.querySelector('.toast-header');
        
        // Définir le contenu
        toastBody.textContent = message;
        
        // Définir le type de notification
        toast.classList.remove('toast-success', 'toast-error', 'toast-warning');
        
        if (type === 'error') {
            toast.classList.add('toast-error');
            toastHeader.querySelector('i').className = 'fas fa-exclamation-circle me-2';
            toastHeader.querySelector('strong').textContent = 'Erreur';
        } else if (type === 'warning') {
            toast.classList.add('toast-warning');
            toastHeader.querySelector('i').className = 'fas fa-exclamation-triangle me-2';
            toastHeader.querySelector('strong').textContent = 'Attention';
        } else {
            toast.classList.add('toast-success');
            toastHeader.querySelector('i').className = 'fas fa-shopping-cart me-2';
            toastHeader.querySelector('strong').textContent = 'Panier';
        }
        
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 5000
        });
        bsToast.show();
    }
}

// Fonction globale pour ajouter au panier
function addToCart(productId, quantity = 1) {
    console.log(`Tentative d'ajout au panier: ID=${productId}, Qté=${quantity}`);
    
    fetch(`/add-to-cart/${productId}`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `quantity=${quantity}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Succès:', data);
            
            // Mettre à jour le compteur directement avec la valeur retournée par l'API
            if (typeof data.cart_count !== 'undefined') {
                updateCartCountDisplay(data.cart_count);
                console.log(`🛒 Compteur mis à jour directement: ${data.cart_count}`);
            } else {
                // Fallback: recharger le compteur depuis l'API
                updateCartCount();
                console.log('🔄 Rechargement compteur via API');
            }
            
            // Afficher la notification
            showCartNotification(`${data.product_name || 'Produit'} ajouté au panier`);
            
            return true;
        } else {
            console.error('Erreur:', data);
            return false;
        }
    })
    .catch(error => {
        console.error('Erreur lors de la requête:', error);
        return false;
    });
}

// Exposer la fonction globalement
window.addToCart = addToCart;

// Bouton "Retour en haut" - Uniquement sur la page d'accueil
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier si nous sommes sur la page d'accueil
    const currentPath = window.location.pathname;
    const isHomePage = currentPath === '/' || currentPath === '/home';
    
    // Ne créer le bouton que sur la page d'accueil
    if (!isHomePage) {
        return;
    }
    
    // Créer le bouton retour en haut
    const scrollToTopBtn = document.createElement('button');
    scrollToTopBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
    scrollToTopBtn.className = 'scroll-to-top-btn';
    scrollToTopBtn.setAttribute('title', 'Retour en haut');
    scrollToTopBtn.setAttribute('aria-label', 'Retour en haut de la page');
    document.body.appendChild(scrollToTopBtn);
    
    // Styles CSS pour le bouton
    const style = document.createElement('style');
    style.textContent = `
        .scroll-to-top-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #0d6efd, #0056b3);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .scroll-to-top-btn.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .scroll-to-top-btn:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13, 110, 253, 0.4);
        }
        
        .scroll-to-top-btn:active {
            transform: translateY(0);
        }
        
        @media (max-width: 768px) {
            .scroll-to-top-btn {
                bottom: 80px; /* Plus haut sur mobile pour éviter les éléments de navigation */
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
        }
    `;
    document.head.appendChild(style);
    
    // Fonction pour afficher/masquer le bouton selon le scroll
    function toggleScrollButton() {
        if (window.pageYOffset > 300) {
            scrollToTopBtn.classList.add('show');
        } else {
            scrollToTopBtn.classList.remove('show');
        }
    }
    
    // Fonction pour le scroll fluide vers le haut
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
    
    // Event listeners
    window.addEventListener('scroll', toggleScrollButton);
    scrollToTopBtn.addEventListener('click', scrollToTop);
});
    </script>
    
    <!-- Footer Newsletter Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Newsletter subscription
        const newsletterBtn = document.querySelector('.newsletter-form .btn');
        const newsletterInput = document.querySelector('.newsletter-form input[type="email"]');
        
        if (newsletterBtn && newsletterInput) {
            newsletterBtn.addEventListener('click', function() {
                const email = newsletterInput.value.trim();
                
                if (!email) {
                    showFooterNotification('Veuillez saisir une adresse email', 'warning');
                    return;
                }
                
                // Simple email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showFooterNotification('Veuillez saisir une adresse email valide', 'error');
                    return;
                }
                
                // Simulate newsletter subscription
                newsletterBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Inscription...';
                newsletterBtn.disabled = true;
                
                setTimeout(() => {
                    newsletterBtn.innerHTML = '<i class="fas fa-check me-1"></i>Inscrit !';
                    newsletterInput.value = '';
                    showFooterNotification('Merci ! Vous êtes maintenant abonné à notre newsletter.', 'success');
                    
                    setTimeout(() => {
                        newsletterBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>S\'abonner';
                        newsletterBtn.disabled = false;
                    }, 2000);
                }, 1500);
            });
            
            // Allow Enter key to submit
            newsletterInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    newsletterBtn.click();
                }
            });
        }
        
        // Smooth scroll for footer links
        document.querySelectorAll('.footer-link[href^="#"]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
        
        // Add hover effects to payment icons
        document.querySelectorAll('.payment-icon').forEach(icon => {
            icon.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.1) rotate(5deg)';
            });
            
            icon.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1) rotate(0deg)';
            });
        });
    });
    
    // Function to show footer notifications
    function showFooterNotification(message, type = 'success') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'success'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    </script>
    
    <!-- Script pour charger automatiquement le compteur du panier -->
    <script>
    // Fonction pour mettre à jour le compteur du panier
    function updateCartCount() {
        fetch('/get-cart-count', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            // Support pour les deux formats d'API (ancien et nouveau)
            const count = data.cart_count !== undefined ? data.cart_count : data.count;
            
            if (typeof count !== 'undefined') {
                updateCartCountDisplay(count);
                console.log(`🛒 Compteur du panier mis à jour via API: ${count}`);
            }
        })
        .catch(error => {
            console.warn('Erreur lors de la mise à jour du compteur du panier:', error);
        });
    }
    
    // Fonction pour mettre à jour directement l'affichage du compteur
    function updateCartCountDisplay(count) {
        const cartCountElements = document.querySelectorAll('.cart-count');
        cartCountElements.forEach(element => {
            // Masquer complètement le badge si le panier est vide
            if (count === 0 || count === null || count === undefined) {
                element.style.display = 'none';
            } else {
                element.textContent = count;
                element.style.display = '';
            }
        });
    }
    
    // Charger le compteur au chargement de la page
    document.addEventListener('DOMContentLoaded', updateCartCount);
    
    // Mettre à jour le compteur périodiquement (toutes les 30 secondes)
    // setInterval(updateCartCount, 30000);
    
    // Mettre à jour le compteur toutes les 30 secondes (optionnel)
    // setInterval(updateCartCount, 30000);
    </script>
    
    <!-- Script pour gérer les erreurs de logo -->
    <script>
    function handleFooterLogoError(img) {
        console.log('🚫 Erreur chargement logo footer:', img.src);
        
        // Liste des URLs de fallback à essayer
        const fallbackUrls = [
            '{{ url_for("static", filename="img/logo.svg") }}',
            '/static/img/logo.svg',
            '/logo',
            '{{ url_for("serve_logo") if url_for("serve_logo", _external=False) else "/static/img/logo.svg" }}'
        ];
        
        // Obtenir l'URL actuelle qui a échoué
        const currentSrc = img.src;
        
        // Trouver le prochain fallback à essayer
        for (let i = 0; i < fallbackUrls.length; i++) {
            if (!currentSrc.includes(fallbackUrls[i]) && fallbackUrls[i] !== currentSrc) {
                console.log('🔄 Tentative fallback footer:', fallbackUrls[i]);
                img.src = fallbackUrls[i];
                return;
            }
        }
        
        // Si tous les fallbacks ont échoué, masquer l'image et afficher seulement le texte
        console.log('❌ Tous les fallbacks footer ont échoué, masquage du logo');
        img.style.display = 'none';
        
        // Optionnel: Ajouter une icône de remplacement
        const iconReplacement = document.createElement('i');
        iconReplacement.className = 'fas fa-store text-warning me-2';
        iconReplacement.style.fontSize = '2rem';
        img.parentNode.insertBefore(iconReplacement, img);
    }
    
    function handleNavbarLogoError(img) {
        console.log('🚫 Erreur chargement logo navbar:', img.src);
        
        // Mêmes fallbacks pour la navbar
        const fallbackUrls = [
            '{{ url_for("static", filename="img/logo.svg") }}',
            '/static/img/logo.svg',
            '/logo',
            '{{ url_for("serve_logo") if url_for("serve_logo", _external=False) else "/static/img/logo.svg" }}'
        ];
        
        const currentSrc = img.src;
        
        for (let i = 0; i < fallbackUrls.length; i++) {
            if (!currentSrc.includes(fallbackUrls[i]) && fallbackUrls[i] !== currentSrc) {
                console.log('🔄 Tentative fallback navbar:', fallbackUrls[i]);
                img.src = fallbackUrls[i];
                return;
            }
        }
        
        console.log('❌ Tous les fallbacks navbar ont échoué, masquage du logo');
        img.style.display = 'none';
    }
    
    // Test de connectivité des images au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        // Tester si les images de logo se chargent correctement
        const logoImages = document.querySelectorAll('img[src*="logo.png"]');
        logoImages.forEach(function(img, index) {
            console.log(`🔍 Test logo ${index + 1}:`, img.src);
            
            // Créer une nouvelle image pour tester
            const testImg = new Image();
            testImg.onload = function() {
                console.log(`✅ Logo ${index + 1} OK:`, img.src);
            };
            testImg.onerror = function() {
                console.log(`❌ Logo ${index + 1} ECHEC:`, img.src);
            };
            testImg.src = img.src;
        });
    });
    </script>
    
    <!-- Ajouter le script cart.js avant la fermeture du body -->
<script src="{{ url_for('static', filename='js/cart.js') }}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>

{% extends 'merchant/layout.html' %}

{% block title %}Gestion des commandes - DOUKA KM Marchands{% endblock %}

{% block merchant_content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Gestion des commandes</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{{ url_for('merchant_dashboard') }}">Tableau de bord</a></li>
        <li class="breadcrumb-item active">Commandes</li>
    </ol>

    <!-- Carte des statistiques rapides -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    Toutes les commandes
                    <h2>{{ orders|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-warning text-white mb-4">
                <div class="card-body">
                    En traitement
                    <h2>{{ orders|selectattr('status', 'equalto', 'processing')|list|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-info text-white mb-4">
                <div class="card-body">
                    Expédiées
                    <h2>{{ orders|selectattr('status', 'equalto', 'shipped')|list|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white mb-4">
                <div class="card-body">
                    Livrées
                    <h2>{{ orders|selectattr('status', 'equalto', 'delivered')|list|length }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtre et recherche -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-filter me-1"></i>
            Filtrer les commandes
        </div>
        <div class="card-body">
            <form id="orderFilterForm" class="row g-3">
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Statut</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">Tous</option>
                        <option value="processing">En traitement</option>
                        <option value="shipped">Expédiée</option>
                        <option value="delivered">Livrée</option>
                        <option value="cancelled">Annulée</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="dateFilter" class="form-label">Date</label>
                    <select class="form-select" id="dateFilter">
                        <option value="">Toutes les dates</option>
                        <option value="today">Aujourd'hui</option>
                        <option value="week">Cette semaine</option>
                        <option value="month">Ce mois</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="searchOrder" class="form-label">Rechercher</label>
                    <input type="text" class="form-control" id="searchOrder" placeholder="N° commande, nom client...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-primary w-100" id="applyFilter">Appliquer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Liste des commandes -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            Liste des commandes
        </div>
        <div class="card-body">
            {% if orders %}
            <div class="table-responsive">
                <table id="ordersTable" class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>N° Commande</th>
                            <th>Date</th>
                            <th>Client</th>
                            <th>Total</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr class="order-row" 
                            data-status="{{ order.status }}"
                            data-date="{{ order.created_at }}"
                            data-order-number="{{ order.order_number }}"
                            data-customer="{{ order.customer_name }}">
                            <td>{{ order.order_number }}</td>
                            <td>{{ order.created_at }}</td>
                            <td>{{ order.customer_name }}</td>
                            <td>{{ order.total|format_number }} KMF</td>
                            <td>
                                <span class="badge 
                                    {% if order.status == 'processing' %}bg-warning
                                    {% elif order.status == 'shipped' %}bg-info
                                    {% elif order.status == 'delivered' %}bg-success
                                    {% elif order.status == 'cancelled' %}bg-danger
                                    {% else %}bg-secondary{% endif %}">
                                    {{ order.status }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('merchant_order_detail', order_id=order.id) }}" class="btn btn-info">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button type="button" class="btn btn-primary update-status-btn" data-order-id="{{ order.id }}" data-bs-toggle="modal" data-bs-target="#updateStatusModal">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                Vous n'avez encore reçu aucune commande.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal pour mettre à jour le statut de la commande -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateStatusModalLabel">Mettre à jour le statut de la commande</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="updateStatusForm" action="#" method="post">
                <div class="modal-body">
                    <input type="hidden" id="modal-order-id" name="order_id">
                    
                    <div class="mb-3">
                        <label for="order-status" class="form-label">Statut</label>
                        <select class="form-select" id="order-status" name="status">
                            <option value="processing">En traitement</option>
                            <option value="shipped">Expédiée</option>
                            <option value="delivered">Livrée</option>
                            <option value="cancelled">Annulée</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="status-notes" class="form-label">Notes (optionnel)</label>
                        <textarea class="form-control" id="status-notes" name="notes" rows="3" placeholder="Ajouter des informations supplémentaires..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialisation de DataTables pour une meilleure expérience utilisateur
        let table = new DataTable('#ordersTable', {
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/fr-FR.json'
            },
            order: [[1, 'desc']] // Trier par date (colonne 1) descendante par défaut
        });
        
        // Gestion des filtres
        document.getElementById('applyFilter').addEventListener('click', function() {
            filterOrders();
        });
        
        document.getElementById('searchOrder').addEventListener('keyup', function() {
            filterOrders();
        });
        
        function filterOrders() {
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            const searchTerm = document.getElementById('searchOrder').value.toLowerCase();
            
            const rows = document.querySelectorAll('.order-row');
            
            rows.forEach(row => {
                const status = row.getAttribute('data-status');
                const date = row.getAttribute('data-date');
                const orderNumber = row.getAttribute('data-order-number').toLowerCase();
                const customer = row.getAttribute('data-customer').toLowerCase();
                
                // Appliquer les filtres
                let showRow = true;
                
                if (statusFilter && status !== statusFilter) {
                    showRow = false;
                }
                
                if (dateFilter) {
                    // Convertir la date de la commande au format JS Date
                    const orderDate = new Date(date);
                    const today = new Date();
                    
                    if (dateFilter === 'today') {
                        // Vérifier si la date est aujourd'hui
                        if (orderDate.toDateString() !== today.toDateString()) {
                            showRow = false;
                        }
                    } else if (dateFilter === 'week') {
                        // Vérifier si la date est dans cette semaine
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay());
                        
                        if (orderDate < weekStart) {
                            showRow = false;
                        }
                    } else if (dateFilter === 'month') {
                        // Vérifier si la date est dans ce mois
                        if (orderDate.getMonth() !== today.getMonth() || 
                            orderDate.getFullYear() !== today.getFullYear()) {
                            showRow = false;
                        }
                    }
                }
                
                // Recherche textuelle
                if (searchTerm && 
                    !(orderNumber.includes(searchTerm) || customer.includes(searchTerm))) {
                    showRow = false;
                }
                
                // Appliquer la visibilité
                if (showRow) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Gestion du modal de mise à jour de statut
        const updateStatusBtns = document.querySelectorAll('.update-status-btn');
        updateStatusBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                document.getElementById('modal-order-id').value = orderId;
            });
        });
        
        // Soumission du formulaire de mise à jour
        document.getElementById('updateStatusForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const orderId = document.getElementById('modal-order-id').value;
            const status = document.getElementById('order-status').value;
            const notes = document.getElementById('status-notes').value;
            
            // Envoyer la mise à jour via AJAX
            fetch(`/merchant/order/${orderId}/update-status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `status=${status}&notes=${notes}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Recharger la page pour afficher les modifications
                    window.location.reload();
                } else {
                    alert('Erreur lors de la mise à jour du statut : ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors de la mise à jour du statut.');
            });
        });
    });
</script>
{% endblock %}

{% extends 'base.html' %}

{% block title %}
  {% if title %}{{ title }}{% else %}Produits | DOUKA KM{% endif %}
{% endblock %}

{% block extra_css %}
<style>
  /* Styles for the filter sidebar */
  @media (min-width: 992px) {
    .filter-sidebar {
      position: sticky;
      top: 20px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }
    
    .filter-toggle-btn {
      display: none;
    }
  }
  
  /* Mobile filter styles */
  @media (max-width: 991.98px) {
    .filter-sidebar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1050;
      background: white;
      padding: 1rem;
      overflow-y: auto;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }
    
    .filter-sidebar.show {
      transform: translateX(0);
    }
    
    .filter-toggle-btn {
      position: fixed;
      bottom: 70px; /* Augmenté pour être plus haut que le footer */
      right: 20px;
      z-index: 1040;
      border-radius: 30px;
      padding: 8px 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .filter-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1049;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
    }
    
    .filter-backdrop.show {
      opacity: 1;
      visibility: visible;
    }
  }
  
  /* Loading indicator */
  .loader-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1500;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
  }
  
  .loader-container.show {
    opacity: 1;
    visibility: visible;
  }
  
  .loader {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #0d6efd;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Styles pour les sous-catégories */
  .category-group {
    margin-bottom: 0.5rem;
  }
  
  .subcategory-group {
    border-left: 2px solid #e9ecef;
    padding-left: 0.5rem;
    transition: all 0.3s ease;
  }
  
  .subcategory-group .form-check {
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
  }
  
  .subcategory-group .form-check-label {
    color: #6c757d;
    font-weight: normal;
  }
  
  .subcategory-group .form-check-input:checked + .form-check-label {
    color: #0d6efd;
    font-weight: 500;
  }
</style>
{% endblock %}

{% block content %}
<div class="loader-container">
  <div class="loader"></div>
</div>

<!-- Filter backdrop overlay for mobile -->
<div class="filter-backdrop" id="filterBackdrop"></div>

<div class="row">
  <!-- Filters sidebar - fixed on desktop, slidable on mobile -->
  <div class="col-lg-3">
    <div class="filter-sidebar d-lg-block" id="filterSidebar">
      <div class="d-flex justify-content-between align-items-center mb-3 d-lg-none">
        <h5 class="mb-0">Filtres</h5>
        <button type="button" class="btn-close" id="closeFilters"></button>
      </div>
      
      <div class="card">
        <div class="card-header d-none d-lg-block">
          <h5 class="mb-0">Filtres</h5>
        </div>
        <div class="card-body">
          <form id="filter-form" action="{{ url_for('products') }}" method="get">
            <!-- Search bar -->
            <div class="mb-4">
              <label for="q" class="form-label">Rechercher</label>
              <div class="input-group">
                <input type="text" class="form-control" id="q" name="q" placeholder="Rechercher..." 
                       value="{{ search_query }}">
                <button class="btn btn-primary" type="submit"><i class="fas fa-search"></i></button>
              </div>
            </div>
            
            <!-- Category filters -->
            <div class="mb-4">
              <h6>Catégories</h6>
              <div class="category-filters">
                {% for category in categories %}
                <div class="form-check category-group">
                  <input class="form-check-input category-checkbox" type="checkbox" name="category_filter" 
                         id="category{{ category.id }}" value="{{ category.id }}"
                         {% if category.id|string in request.args.getlist('category_filter') %}checked{% endif %}
                         data-category-id="{{ category.id }}">
                  <label class="form-check-label" for="category{{ category.id }}">
                    {{ category.name }}
                  </label>
                  
                  <!-- Sous-catégories (cachées par défaut) -->
                  {% if category.subcategories %}
                  <div class="subcategory-group ms-3 mt-2" id="subcategories-{{ category.id }}" style="display: none;">
                    {% for subcategory in category.subcategories %}
                    <div class="form-check">
                      <input class="form-check-input subcategory-checkbox" type="checkbox" name="subcategory_filter" 
                             id="subcategory{{ subcategory.id }}" value="{{ subcategory.id }}"
                             {% if subcategory.id|string in request.args.getlist('subcategory_filter') %}checked{% endif %}
                             data-parent-category="{{ category.id }}">
                      <label class="form-check-label" for="subcategory{{ subcategory.id }}">
                        {{ subcategory.name }}
                      </label>
                    </div>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
            </div>
            
            <!-- Price filters -->
            <div class="mb-4">
              <h6>Prix</h6>
              <div class="row">
                <div class="col-6">
                  <label for="min_price" class="form-label">Min</label>
                  <input type="number" class="form-control form-control-sm" id="min_price" name="min_price" 
                         placeholder="Min" value="{{ request.args.get('min_price', '') }}">
                </div>
                <div class="col-6">
                  <label for="max_price" class="form-label">Max</label>
                  <input type="number" class="form-control form-control-sm" id="max_price" name="max_price" 
                         placeholder="Max" value="{{ request.args.get('max_price', '') }}">
                </div>
              </div>
            </div>
            
            <!-- In stock filter -->
            <div class="mb-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="in_stock" name="in_stock" value="1"
                       {% if request.args.get('in_stock') %}checked{% endif %}>
                <label class="form-check-label" for="in_stock">
                  En stock uniquement
                </label>
              </div>
            </div>
            
            <!-- Sort options -->
            <div class="mb-4">
              <label for="sort" class="form-label">Trier par</label>
              <select class="form-select form-select-sm" name="sort" id="sort">
                <option value="newest" {% if sort_option == 'newest' or sort_option == 'default' %}selected{% endif %}>Plus récents</option>
                <option value="oldest" {% if sort_option == 'oldest' %}selected{% endif %}>Plus anciens</option>
                <option value="price_asc" {% if sort_option == 'price_asc' %}selected{% endif %}>Prix croissant</option>
                <option value="price_desc" {% if sort_option == 'price_desc' %}selected{% endif %}>Prix décroissant</option>
                <option value="name_asc" {% if sort_option == 'name_asc' %}selected{% endif %}>Nom A-Z</option>
                <option value="name_desc" {% if sort_option == 'name_desc' %}selected{% endif %}>Nom Z-A</option>
              </select>
            </div>
            
            <button type="submit" class="btn btn-primary w-100">Appliquer</button>
            <a href="{{ url_for('products') }}" class="btn btn-outline-secondary w-100 mt-2">Réinitialiser</a>
            <button type="button" class="btn btn-link text-secondary w-100 mt-2 d-lg-none" id="cancelFilterBtn">
              Annuler
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Product grid -->
  <div class="col-lg-9">
    <!-- Breadcrumb et navigation des catégories -->
    {% if current_category %}
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('products') }}">Tous les produits</a></li>
        <li class="breadcrumb-item">
          <a href="{{ url_for('category', category_slug=current_category.slug) }}">{{ current_category.name }}</a>
        </li>
        {% if current_subcategory %}
        <li class="breadcrumb-item active" aria-current="page">{{ current_subcategory.name }}</li>
        {% endif %}
      </ol>
    </nav>
    
    <!-- Navigation des sous-catégories -->
    {% if current_category and current_category.subcategories and not current_subcategory %}
    <div class="mb-4">
      <h5 class="mb-3">Sous-catégories de {{ current_category.name }}</h5>
      <div class="row g-2">
        {% for subcategory_slug, subcategory in current_category.subcategories.items() %}
        <div class="col-6 col-md-4 col-lg-3">
          <a href="{{ url_for('category', category_slug=current_category.slug, subcategory_slug=subcategory_slug) }}" 
             class="btn btn-outline-primary w-100 text-start">
            <i class="fas fa-tag me-2"></i>{{ subcategory.name }}
          </a>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
    {% endif %}
    
    <div class="mb-3 d-flex justify-content-between align-items-center">
      <h2>
        {% if current_subcategory %}
          {{ current_subcategory.name }}
        {% elif current_category %}
          {{ current_category.name }}
        {% else %}
          Produits
        {% endif %}
      </h2>
      <!-- Mobile sort dropdown -->
      <div class="dropdown d-lg-none">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" 
                data-bs-toggle="dropdown" aria-expanded="false">
          Trier par
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sortDropdown">
          <li><a class="dropdown-item" href="{{ url_for('products', sort='newest') }}">Plus récents</a></li>
          <li><a class="dropdown-item" href="{{ url_for('products', sort='oldest') }}">Plus anciens</a></li>
          <li><a class="dropdown-item" href="{{ url_for('products', sort='price_asc') }}">Prix croissant</a></li>
          <li><a class="dropdown-item" href="{{ url_for('products', sort='price_desc') }}">Prix décroissant</a></li>
          <li><a class="dropdown-item" href="{{ url_for('products', sort='name_asc') }}">Nom A-Z</a></li>
          <li><a class="dropdown-item" href="{{ url_for('products', sort='name_desc') }}">Nom Z-A</a></li>
        </ul>
      </div>
    </div>
    
    {% if products %}
    <div class="row row-cols-2 row-cols-md-2 row-cols-xl-3 g-2 g-md-4">
      {% for product in products %}
      <div class="col">
        <!-- Lien pour mobile - enveloppe toute la carte -->
        <a href="{{ url_for('product_detail', product_id=product.id) }}" class="d-block d-md-none text-decoration-none text-dark">
          <div class="card h-100 product-card">
            <img src="{{ product.image }}" 
                 class="card-img-top" alt="{{ product.name }}" loading="lazy"
                 onerror="this.src='https://via.placeholder.com/400x300?text=Image+non+disponible'">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">{{ product.name }}</h5>
              <p class="card-text text-muted mb-2 d-none d-md-block">{{ product.description[:100] }}{% if product.description|length > 100 %}...{% endif %}</p>
              
              <!-- Informations du marchand -->
              {% if product.merchant_name %}
              <div class="merchant-info mb-3">
                <small class="text-muted">
                  <i class="fas fa-store me-1"></i>
                  Vendu par: <strong>{{ product.merchant_name }}</strong>
                </small>
              </div>
              {% endif %}
              
              <div class="mt-auto">
                <div class="fw-bold fs-5 text-primary mb-3">{{ product.price|format_number }} KMF</div>
                <!-- Sur mobile, on affiche seulement le bouton panier -->
                <div class="action-buttons">
                  <button class="btn w-100 add-to-cart-btn 
                                 {% if product.stock is defined and product.stock <= 0 %}btn-secondary{% else %}btn-primary{% endif %}" 
                          data-product-id="{{ product.id }}" 
                          onclick="event.preventDefault(); event.stopPropagation();"
                          {% if product.stock is defined and product.stock <= 0 %}disabled{% endif %}>
                    <i class="fas fa-{% if product.stock is defined and product.stock <= 0 %}ban{% else %}cart-plus{% endif %} me-1"></i> 
                    {% if product.stock is defined and product.stock <= 0 %}
                      Rupture de stock
                    {% else %}
                      Ajouter au panier
                    {% endif %}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </a>
        
        <!-- Structure pour desktop (inchangée) -->
        <div class="card h-100 product-card d-none d-md-block">
          <img src="{{ product.image }}" 
               class="card-img-top" alt="{{ product.name }}" loading="lazy"
               onerror="this.src='https://via.placeholder.com/400x300?text=Image+non+disponible'">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ product.name }}</h5>
            <p class="card-text text-muted mb-2 d-none d-md-block">{{ product.description[:100] }}{% if product.description|length > 100 %}...{% endif %}</p>
            
            <!-- Informations du marchand -->
            {% if product.merchant_name %}
            <div class="merchant-info mb-3">
              <small class="text-muted">
                <i class="fas fa-store me-1"></i>
                Vendu par: <strong>{{ product.merchant_name }}</strong>
              </small>
            </div>
            {% endif %}
            
            <div class="mt-auto">
              <div class="fw-bold fs-5 text-primary mb-3">{{ product.price|format_number }} KMF</div>
              <div class="action-buttons">
                <a href="{{ url_for('product_detail', product_id=product.id) }}" class="btn btn-sm btn-outline-secondary">Détails</a>
                <button class="btn add-to-cart-btn 
                               {% if product.stock is defined and product.stock <= 0 %}btn-secondary{% else %}btn-primary{% endif %}" 
                        data-product-id="{{ product.id }}"
                        {% if product.stock is defined and product.stock <= 0 %}disabled{% endif %}>
                  <i class="fas fa-{% if product.stock is defined and product.stock <= 0 %}ban{% else %}cart-plus{% endif %} me-1"></i> 
                  {% if product.stock is defined and product.stock <= 0 %}
                    Rupture de stock
                  {% else %}
                    Ajouter au panier
                  {% endif %}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if pagination and pagination.total_pages > 1 %}
    <div class="row mt-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <small class="text-muted">
            Affichage de {{ pagination.start_index }} à {{ pagination.end_index }} sur {{ pagination.total }} produits
          </small>
        </div>
        
        <nav aria-label="Navigation des produits">
          <ul class="pagination justify-content-center">
            <!-- Bouton Précédent -->
            {% if pagination.has_prev %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('products', page=pagination.prev_page, q=search_query, sort=sort_option, **request.args.to_dict(flat=False)) }}" aria-label="Précédent">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link" aria-label="Précédent">
                  <span aria-hidden="true">&laquo;</span>
                </span>
              </li>
            {% endif %}
            
            <!-- Numéros de page -->
            {% for page_num in range(1, pagination.total_pages + 1) %}
              {% if page_num == pagination.page %}
                <li class="page-item active">
                  <span class="page-link">{{ page_num }}</span>
                </li>
              {% elif page_num <= 3 or page_num > pagination.total_pages - 3 or (page_num >= pagination.page - 1 and page_num <= pagination.page + 1) %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('products', page=page_num, q=search_query, sort=sort_option, **request.args.to_dict(flat=False)) }}">{{ page_num }}</a>
                </li>
              {% elif page_num == 4 and pagination.page > 5 %}
                <li class="page-item disabled">
                  <span class="page-link">...</span>
                </li>
              {% elif page_num == pagination.total_pages - 3 and pagination.page < pagination.total_pages - 4 %}
                <li class="page-item disabled">
                  <span class="page-link">...</span>
                </li>
              {% endif %}
            {% endfor %}
            
            <!-- Bouton Suivant -->
            {% if pagination.has_next %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('products', page=pagination.next_page, q=search_query, sort=sort_option, **request.args.to_dict(flat=False)) }}" aria-label="Suivant">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link" aria-label="Suivant">
                  <span aria-hidden="true">&raquo;</span>
                </span>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
    {% endif %}
    
    {% else %}
    <div class="alert alert-info">
      <i class="fas fa-info-circle me-2"></i> Aucun produit ne correspond à vos critères de recherche.
    </div>
    {% endif %}
  </div>
</div>

<!-- Mobile filter toggle button -->
<button class="btn btn-primary filter-toggle-btn" id="filterToggleBtn">
  <i class="fas fa-filter"></i> Filtres
</button>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Show loader while page is loading
  const loaderContainer = document.querySelector('.loader-container');
  if (loaderContainer) {
    loaderContainer.classList.add('show');
    window.addEventListener('load', function() {
      loaderContainer.classList.remove('show');
      setTimeout(() => {
        loaderContainer.style.display = 'none';
      }, 300);
    });
  }
  
  // Filter sidebar functionality
  const filterToggleBtn = document.getElementById('filterToggleBtn');
  const filterSidebar = document.getElementById('filterSidebar');
  const filterBackdrop = document.getElementById('filterBackdrop');
  const closeFiltersBtn = document.getElementById('closeFilters');
  const cancelFilterBtn = document.getElementById('cancelFilterBtn');
  
  function openFilters() {
    filterSidebar.classList.add('show');
    filterBackdrop.classList.add('show');
    document.body.style.overflow = 'hidden';
  }
  
  function hideFilters() {
    filterSidebar.classList.remove('show');
    filterBackdrop.classList.remove('show');
    document.body.style.overflow = '';
  }
  
  if (filterToggleBtn) {
    filterToggleBtn.addEventListener('click', openFilters);
  }
  
  if (closeFiltersBtn) {
    closeFiltersBtn.addEventListener('click', hideFilters);
  }
  
  if (cancelFilterBtn) {
    cancelFilterBtn.addEventListener('click', hideFilters);
  }
  
  if (filterBackdrop) {
    filterBackdrop.addEventListener('click', hideFilters);
  }
  
  // Auto-submit on sort change
  const sortSelect = document.getElementById('sort');
  if (sortSelect) {
    sortSelect.addEventListener('change', function() {
      this.closest('form').submit();
    });
  }
  
  // Gestion des sous-catégories
  const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
  const subcategoryCheckboxes = document.querySelectorAll('.subcategory-checkbox');
  
  // Fonction pour afficher/masquer les sous-catégories
  function toggleSubcategories(categoryId, show) {
    const subcategoryGroup = document.getElementById('subcategories-' + categoryId);
    if (subcategoryGroup) {
      subcategoryGroup.style.display = show ? 'block' : 'none';
      
      // Si on masque, décocher toutes les sous-catégories de cette catégorie
      if (!show) {
        const subcats = subcategoryGroup.querySelectorAll('.subcategory-checkbox');
        subcats.forEach(subcat => {
          subcat.checked = false;
        });
      }
    }
  }
  
  // Gérer les clics sur les catégories
  categoryCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const categoryId = this.getAttribute('data-category-id');
      
      if (this.checked) {
        // Afficher les sous-catégories quand la catégorie est cochée
        toggleSubcategories(categoryId, true);
      } else {
        // Masquer les sous-catégories quand la catégorie est décochée
        toggleSubcategories(categoryId, false);
      }
    });
    
    // Afficher les sous-catégories si la catégorie est déjà cochée au chargement
    if (checkbox.checked) {
      const categoryId = checkbox.getAttribute('data-category-id');
      toggleSubcategories(categoryId, true);
    }
  });
  
  // Auto-submit du formulaire quand on change une sous-catégorie
  subcategoryCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      // Soumettre le formulaire automatiquement
      this.closest('form').submit();
    });
  });
  
  // Auto-submit du formulaire quand on change une catégorie
  categoryCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      // Soumettre le formulaire automatiquement
      this.closest('form').submit();
    });
  });
  
  // Add to cart functionality for product buttons
  const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
  addToCartButtons.forEach(button => {
    button.addEventListener('click', function() {
      // Ne pas traiter si le bouton est déjà désactivé (rupture de stock)
      if (this.disabled) {
        return;
      }
      
      const productId = this.getAttribute('data-product-id');
      // Disable button while processing
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Ajout...';
      
      // Call the global addToCart function
      if (typeof window.addToCart === 'function') {
        window.addToCart(productId);
        
        // Re-enable button after short delay
        setTimeout(() => {
          this.disabled = false;
          this.innerHTML = '<i class="fas fa-cart-plus me-1"></i> Ajouter au panier';
        }, 800);
      }
    });
  });
});
</script>
{% endblock %}

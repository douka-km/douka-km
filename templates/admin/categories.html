{% extends 'admin/layout.html' %}

{% block title %}Gestion des cat√©gories - DOUKA KM{% endblock %}
{% block page_title %}Gestion des cat√©gories{% endblock %}

{% block admin_content %}
    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ stats.total_categories }}</h4>
                            <p class="card-text">Total cat√©gories</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-tags fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ stats.active_categories }}</h4>
                            <p class="card-text">Cat√©gories actives</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ stats.total_products }}</h4>
                            <p class="card-text">Total produits</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-box fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ stats.products_with_category }}</h4>
                            <p class="card-text">Produits cat√©goris√©s</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-list fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="mb-0">
                        <i class="fas fa-tags me-2"></i> Cat√©gories de produits
                    </h5>
                    <p class="text-muted mb-0">G√©rez les cat√©gories pour organiser vos produits</p>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                        <i class="fas fa-plus me-2"></i> Ajouter une cat√©gorie
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des cat√©gories -->
    <div class="row">
        {% for category in categories %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-box me-3" style="width: 50px; height: 50px; background: linear-gradient(45deg, #007bff, #0056b3); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <i class="{{ category.icon }} text-white fa-lg"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-1">{{ category.name }}</h5>
                            <span class="badge {{ 'bg-success' if category.active else 'bg-secondary' }}">
                                {{ 'Actif' if category.active else 'Inactif' }}
                            </span>
                        </div>
                    </div>
                    
                    <p class="card-text text-muted">{{ category.description }}</p>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-primary me-2">{{ category.products_count }} produit(s)</span>
                            <span class="badge bg-info">{{ category.subcategories_count }} sous-cat√©gorie(s)</span>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('admin_category_detail', category_id=category.id) }}" 
                               class="btn btn-outline-primary" title="Voir les produits">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button class="btn btn-outline-secondary edit-category-btn" 
                                    data-category-id="{{ category.id }}"
                                    data-category-name="{{ category.name }}"
                                    data-category-description="{{ category.description }}"
                                    data-category-icon="{{ category.icon }}"
                                    title="Modifier">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-{{ 'warning' if category.active else 'success' }} toggle-category-btn" 
                                    data-category-id="{{ category.id }}"
                                    data-category-active="{{ category.active|lower }}"
                                    title="{{ 'D√©sactiver' if category.active else 'Activer' }}">
                                <i class="fas fa-{{ 'pause' if category.active else 'play' }}"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Modal d'ajout de cat√©gorie -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajouter une nouvelle cat√©gorie</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="#">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">Nom de la cat√©gorie</label>
                            <input type="text" class="form-control" id="categoryName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="categoryDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="categoryDescription" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="categoryIcon" class="form-label">Ic√¥ne (FontAwesome)</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i id="categoryIconPreview" class="fas fa-box"></i>
                                </span>
                                <input type="text" class="form-control" id="categoryIcon" name="icon" placeholder="fas fa-box" value="fas fa-box">
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#iconSelectorModal">
                                    <i class="fas fa-search"></i> Choisir
                                </button>
                            </div>
                            <small class="text-muted">Tapez ou choisissez une ic√¥ne FontAwesome</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Ajouter la cat√©gorie</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de modification de cat√©gorie -->
    <div class="modal fade" id="editCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifier la cat√©gorie</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="#" id="editCategoryForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editCategoryName" class="form-label">Nom de la cat√©gorie</label>
                            <input type="text" class="form-control" id="editCategoryName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="editCategoryDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editCategoryDescription" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editCategoryIcon" class="form-label">Ic√¥ne (FontAwesome)</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i id="editCategoryIconPreview" class="fas fa-box"></i>
                                </span>
                                <input type="text" class="form-control" id="editCategoryIcon" name="icon">
                                <button type="button" class="btn btn-outline-secondary" onclick="openIconSelector('edit')">
                                    <i class="fas fa-search"></i> Choisir
                                </button>
                            </div>
                            <small class="text-muted">Tapez ou choisissez une ic√¥ne FontAwesome</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Sauvegarder les modifications</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de s√©lection d'ic√¥nes -->
    <div class="modal fade" id="iconSelectorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Choisir une ic√¥ne FontAwesome</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Recherche d'ic√¥nes -->
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="iconSearch" placeholder="Rechercher une ic√¥ne..." onkeyup="filterIcons()">
                        </div>
                    </div>
                    
                    <!-- Cat√©gories d'ic√¥nes -->
                    <ul class="nav nav-tabs mb-3" id="iconCategoryTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#popularIcons">Populaires</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#businessIcons">Commerce</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#foodIcons">Alimentation</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#fashionIcons">Mode</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#techIcons">Technologie</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#generalIcons">G√©n√©ral</a>
                        </li>
                    </ul>
                    
                    <!-- Contenu des onglets -->
                    <div class="tab-content" id="iconTabContent">
                        <!-- Ic√¥nes populaires -->
                        <div class="tab-pane fade show active" id="popularIcons">
                            <div class="row g-2" id="popularIconsGrid">
                                <!-- Les ic√¥nes seront ajout√©es dynamiquement -->
                            </div>
                        </div>
                        
                        <!-- Ic√¥nes commerce -->
                        <div class="tab-pane fade" id="businessIcons">
                            <div class="row g-2" id="businessIconsGrid">
                                <!-- Les ic√¥nes seront ajout√©es dynamiquement -->
                            </div>
                        </div>
                        
                        <!-- Ic√¥nes alimentation -->
                        <div class="tab-pane fade" id="foodIcons">
                            <div class="row g-2" id="foodIconsGrid">
                                <!-- Les ic√¥nes seront ajout√©es dynamiquement -->
                            </div>
                        </div>
                        
                        <!-- Ic√¥nes mode -->
                        <div class="tab-pane fade" id="fashionIcons">
                            <div class="row g-2" id="fashionIconsGrid">
                                <!-- Les ic√¥nes seront ajout√©es dynamiquement -->
                            </div>
                        </div>
                        
                        <!-- Ic√¥nes technologie -->
                        <div class="tab-pane fade" id="techIcons">
                            <div class="row g-2" id="techIconsGrid">
                                <!-- Les ic√¥nes seront ajout√©es dynamiquement -->
                            </div>
                        </div>
                        
                        <!-- Ic√¥nes g√©n√©rales -->
                        <div class="tab-pane fade" id="generalIcons">
                            <div class="row g-2" id="generalIconsGrid">
                                <!-- Les ic√¥nes seront ajout√©es dynamiquement -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Aper√ßu de l'ic√¥ne s√©lectionn√©e -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i id="selectedIconPreview" class="fas fa-box fa-2x text-primary"></i>
                            </div>
                            <div>
                                <strong>Ic√¥ne s√©lectionn√©e:</strong>
                                <code id="selectedIconCode">fas fa-box</code>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Suggestions intelligentes -->
                    <div class="mt-3" id="smartSuggestions" style="display: none;">
                        <h6 class="mb-2">
                            <i class="fas fa-lightbulb text-warning me-2"></i>
                            Suggestions pour "<span id="suggestionCategoryName"></span>"
                        </h6>
                        <div class="row g-2" id="suggestedIconsGrid">
                            <!-- Les suggestions seront ajout√©es ici -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="selectIcon()">Utiliser cette ic√¥ne</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// Base de donn√©es d'ic√¥nes FontAwesome organis√©es par cat√©gorie
const iconDatabase = {
    popular: [
        'fas fa-box', 'fas fa-shopping-cart', 'fas fa-store', 'fas fa-tag', 'fas fa-tags',
        'fas fa-heart', 'fas fa-star', 'fas fa-user', 'fas fa-users', 'fas fa-home',
        'fas fa-phone', 'fas fa-envelope', 'fas fa-globe', 'fas fa-search', 'fas fa-cog'
    ],
    business: [
        'fas fa-store', 'fas fa-shopping-cart', 'fas fa-shopping-bag', 'fas fa-cash-register',
        'fas fa-credit-card', 'fas fa-money-bill-wave', 'fas fa-coins', 'fas fa-receipt',
        'fas fa-handshake', 'fas fa-chart-line', 'fas fa-briefcase', 'fas fa-building',
        'fas fa-warehouse', 'fas fa-truck', 'fas fa-shipping-fast', 'fas fa-clipboard-list'
    ],
    food: [
        'fas fa-utensils', 'fas fa-hamburger', 'fas fa-pizza-slice', 'fas fa-coffee',
        'fas fa-wine-glass', 'fas fa-beer', 'fas fa-cookie-bite', 'fas fa-ice-cream',
        'fas fa-apple-alt', 'fas fa-carrot', 'fas fa-fish', 'fas fa-egg',
        'fas fa-bread-slice', 'fas fa-cheese', 'fas fa-birthday-cake', 'fas fa-seedling'
    ],
    fashion: [
        'fas fa-tshirt', 'fas fa-hat-cowboy', 'fas fa-glasses', 'fas fa-gem',
        'fas fa-ring', 'fas fa-shoe-prints', 'fas fa-socks', 'fas fa-mitten',
        'fas fa-crown', 'fas fa-tie', 'fas fa-vest', 'fas fa-user-tie',
        'fas fa-shopping-bag', 'fas fa-tags', 'fas fa-palette', 'fas fa-cut'
    ],
    tech: [
        'fas fa-laptop', 'fas fa-mobile-alt', 'fas fa-tablet-alt', 'fas fa-desktop',
        'fas fa-keyboard', 'fas fa-mouse', 'fas fa-headphones', 'fas fa-microchip',
        'fas fa-wifi', 'fas fa-bluetooth', 'fas fa-camera', 'fas fa-video',
        'fas fa-gamepad', 'fas fa-tv', 'fas fa-plug', 'fas fa-battery-full'
    ],
    general: [
        'fas fa-home', 'fas fa-car', 'fas fa-plane', 'fas fa-bicycle',
        'fas fa-book', 'fas fa-music', 'fas fa-film', 'fas fa-paint-brush',
        'fas fa-tools', 'fas fa-wrench', 'fas fa-hammer', 'fas fa-leaf',
        'fas fa-paw', 'fas fa-baby', 'fas fa-graduation-cap', 'fas fa-dumbbell'
    ]
};

// Suggestions intelligentes d'ic√¥nes
const iconSuggestions = {
    keywordMapping: {
        // Commerce et vente
        'commerce': 'fas fa-store', 'vente': 'fas fa-shopping-cart', 'magasin': 'fas fa-store-alt',
        'boutique': 'fas fa-shopping-bag', 'achat': 'fas fa-credit-card', 'paiement': 'fas fa-money-bill-wave',
        
        // √âlectronique
        '√©lectronique': 'fas fa-microchip', 'electronique': 'fas fa-microchip', 'tech': 'fas fa-laptop',
        'technologie': 'fas fa-laptop', 'ordinateur': 'fas fa-desktop', 't√©l√©phone': 'fas fa-mobile-alt',
        'smartphone': 'fas fa-mobile-alt', 'tablette': 'fas fa-tablet-alt',
        
        // Mode et v√™tements
        'mode': 'fas fa-tshirt', 'v√™tement': 'fas fa-tshirt', 'vetement': 'fas fa-tshirt',
        'fashion': 'fas fa-tshirt', 'chaussure': 'fas fa-shoe-prints', 'accessoire': 'fas fa-gem',
        'bijou': 'fas fa-ring', 'sac': 'fas fa-shopping-bag', 'chapeau': 'fas fa-hat-cowboy',
        
        // Alimentation
        'alimentation': 'fas fa-utensils', 'nourriture': 'fas fa-hamburger', 'food': 'fas fa-utensils',
        'restaurant': 'fas fa-utensils', 'cuisine': 'fas fa-utensils', 'boisson': 'fas fa-coffee',
        '√©picerie': 'fas fa-shopping-cart', 'fruits': 'fas fa-apple-alt', 'l√©gumes': 'fas fa-carrot',
        
        // Sant√© et beaut√©
        'sant√©': 'fas fa-heartbeat', 'sante': 'fas fa-heartbeat', 'health': 'fas fa-heartbeat',
        'beaut√©': 'fas fa-palette', 'beaute': 'fas fa-palette', 'beauty': 'fas fa-palette',
        'cosm√©tique': 'fas fa-palette', 'parfum': 'fas fa-spray-can', 'maquillage': 'fas fa-paint-brush',
        
        // Maison et jardin
        'maison': 'fas fa-home', 'home': 'fas fa-home', 'jardin': 'fas fa-seedling',
        'garden': 'fas fa-seedling', 'd√©coration': 'fas fa-paint-brush', 'meuble': 'fas fa-couch',
        '√©lectrom√©nager': 'fas fa-blender', 'bricolage': 'fas fa-tools',
        
        // Sport
        'sport': 'fas fa-dumbbell', 'fitness': 'fas fa-dumbbell', 'gym': 'fas fa-dumbbell',
        'course': 'fas fa-running', 'natation': 'fas fa-swimmer', 'football': 'fas fa-football-ball',
        
        // B√©b√© et enfants
        'b√©b√©': 'fas fa-baby', 'bebe': 'fas fa-baby', 'baby': 'fas fa-baby',
        'enfant': 'fas fa-baby', 'kids': 'fas fa-baby', 'jouet': 'fas fa-gamepad',
        
        // Automobile
        'auto': 'fas fa-car', 'automobile': 'fas fa-car', 'voiture': 'fas fa-car',
        'moto': 'fas fa-motorcycle', 'v√©lo': 'fas fa-bicycle', 'transport': 'fas fa-truck',
        
        // Animaux
        'animal': 'fas fa-paw', 'pet': 'fas fa-paw', 'chien': 'fas fa-dog',
        'chat': 'fas fa-cat', 'poisson': 'fas fa-fish', 'oiseau': 'fas fa-dove',
        
        // Livres et √©ducation
        'livre': 'fas fa-book', 'book': 'fas fa-book', '√©ducation': 'fas fa-graduation-cap',
        'education': 'fas fa-graduation-cap', '√©cole': 'fas fa-school', 'universit√©': 'fas fa-university',
        
        // Artisanat
        'artisanat': 'fas fa-palette', 'art': 'fas fa-paint-brush', 'craft': 'fas fa-palette',
        'traditionnel': 'fas fa-palette', 'local': 'fas fa-map-marker-alt', 'fait main': 'fas fa-hand-paper'
    },
    
    suggest: function(categoryName) {
        if (!categoryName || categoryName.length < 2) return 'fas fa-box';
        
        const name = categoryName.toLowerCase().trim();
        console.log('üîç Recherche suggestion pour:', name);
        
        // Recherche exacte d'abord
        if (this.keywordMapping[name]) {
            console.log('‚úÖ Correspondance exacte trouv√©e:', this.keywordMapping[name]);
            return this.keywordMapping[name];
        }
        
        // Recherche par inclusion de mots-cl√©s (plus flexible)
        let bestMatch = null;
        let bestScore = 0;
        
        for (const keyword in this.keywordMapping) {
            let score = 0;
            
            // Score √©lev√© si le nom contient le mot-cl√©
            if (name.includes(keyword)) {
                score = keyword.length; // Plus le mot-cl√© est long, plus le score est √©lev√©
            }
            // Score moyen si le mot-cl√© contient le nom
            else if (keyword.includes(name)) {
                score = name.length * 0.7;
            }
            // Score faible pour correspondances partielles
            else if (this.partialMatch(name, keyword)) {
                score = Math.min(name.length, keyword.length) * 0.3;
            }
            
            if (score > bestScore) {
                bestScore = score;
                bestMatch = this.keywordMapping[keyword];
            }
        }
        
        if (bestMatch) {
            console.log('‚úÖ Meilleure correspondance trouv√©e:', bestMatch, 'avec score:', bestScore);
            return bestMatch;
        }
        
        console.log('‚ùå Aucune correspondance, utilisation de l\'ic√¥ne par d√©faut');
        return 'fas fa-box';
    },
    
    // Fonction pour d√©tecter des correspondances partielles
    partialMatch: function(str1, str2) {
        // V√©rifier si les cha√Ænes partagent des sous-cha√Ænes de 3+ caract√®res
        if (str1.length < 3 || str2.length < 3) return false;
        
        for (let i = 0; i <= str1.length - 3; i++) {
            const substr = str1.substring(i, i + 3);
            if (str2.includes(substr)) {
                return true;
            }
        }
        return false;
    },
    
    getMultipleSuggestions: function(categoryName) {
        const suggestions = [];
        const name = categoryName.toLowerCase().trim();
        
        if (!name || name.length < 2) {
            return ['fas fa-box', 'fas fa-tag', 'fas fa-star', 'fas fa-heart', 'fas fa-gem', 'fas fa-check-circle'];
        }
        
        console.log('üîç G√©n√©ration de suggestions multiples pour:', name);
        
        // Ajouter l'ic√¥ne principale sugg√©r√©e
        const mainSuggestion = this.suggest(categoryName);
        suggestions.push(mainSuggestion);
        
        // Scores pour toutes les correspondances
        const matches = [];
        
        Object.keys(this.keywordMapping).forEach(keyword => {
            let score = 0;
            
            if (name.includes(keyword)) {
                score = keyword.length * 2; // Score √©lev√© pour inclusion
            } else if (keyword.includes(name)) {
                score = name.length * 1.5; // Score moyen pour inclusion inverse
            } else if (this.partialMatch(name, keyword)) {
                score = Math.min(name.length, keyword.length); // Score faible pour correspondances partielles
            }
            
            if (score > 0) {
                matches.push({
                    keyword: keyword,
                    icon: this.keywordMapping[keyword],
                    score: score
                });
            }
        });
        
        // Trier par score d√©croissant
        matches.sort((a, b) => b.score - a.score);
        
        // Ajouter les meilleures correspondances (en √©vitant les doublons)
        matches.forEach(match => {
            if (suggestions.length < 6 && !suggestions.includes(match.icon)) {
                suggestions.push(match.icon);
            }
        });
        
        // Si pas assez de suggestions, ajouter des ic√¥nes populaires
        const popularIcons = [
            'fas fa-star', 'fas fa-heart', 'fas fa-check-circle', 'fas fa-gem', 
            'fas fa-award', 'fas fa-crown', 'fas fa-fire', 'fas fa-bolt'
        ];
        
        popularIcons.forEach(icon => {
            if (suggestions.length < 6 && !suggestions.includes(icon)) {
                suggestions.push(icon);
            }
        });
        
        console.log('‚úÖ Suggestions g√©n√©r√©es:', suggestions);
        return suggestions.slice(0, 6);
    }
};

let currentMode = 'add'; // 'add' ou 'edit'
let selectedIcon = 'fas fa-box';

// Initialiser le s√©lecteur d'ic√¥nes
function initIconSelector() {
    // Remplir chaque cat√©gorie d'ic√¥nes
    Object.keys(iconDatabase).forEach(category => {
        const gridId = category + 'IconsGrid';
        const grid = document.getElementById(gridId);
        if (grid) {
            grid.innerHTML = '';
            iconDatabase[category].forEach(icon => {
                const iconElement = createIconElement(icon);
                grid.appendChild(iconElement);
            });
        }
    });
}

// Cr√©er un √©l√©ment d'ic√¥ne cliquable
function createIconElement(iconClass) {
    const col = document.createElement('div');
    col.className = 'col-2 col-sm-1';
    
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'btn btn-outline-secondary w-100 icon-btn';
    button.style.aspectRatio = '1';
    button.setAttribute('data-icon', iconClass);
    button.title = iconClass;
    button.onclick = function() { previewIcon(iconClass); };
    
    const icon = document.createElement('i');
    icon.className = iconClass;
    
    button.appendChild(icon);
    col.appendChild(button);
    
    return col;
}

// Pr√©visualiser une ic√¥ne
function previewIcon(iconClass) {
    selectedIcon = iconClass;
    
    // Mettre √† jour l'aper√ßu dans le modal
    const preview = document.getElementById('selectedIconPreview');
    const code = document.getElementById('selectedIconCode');
    
    if (preview && code) {
        preview.className = iconClass + ' fa-2x text-primary';
        code.textContent = iconClass;
    }
    
    // Mettre en surbrillance l'ic√¥ne s√©lectionn√©e
    document.querySelectorAll('.icon-btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-secondary');
    });
    
    const selectedBtn = document.querySelector(`[data-icon="${iconClass}"]`);
    if (selectedBtn) {
        selectedBtn.classList.remove('btn-outline-secondary');
        selectedBtn.classList.add('btn-primary');
    }
}

// Filtrer les ic√¥nes par recherche
function filterIcons() {
    const searchTerm = document.getElementById('iconSearch').value.toLowerCase();
    
    if (searchTerm.length === 0) {
        // R√©initialiser l'affichage normal
        initIconSelector();
        return;
    }
    
    // Rechercher dans toutes les cat√©gories
    const allIcons = Object.values(iconDatabase).flat();
    const filteredIcons = allIcons.filter(icon => 
        icon.toLowerCase().includes(searchTerm) ||
        icon.replace('fas fa-', '').replace('-', ' ').toLowerCase().includes(searchTerm)
    );
    
    // Afficher les r√©sultats dans l'onglet actif
    const activeTab = document.querySelector('.tab-pane.active .row');
    if (activeTab) {
        activeTab.innerHTML = '';
        filteredIcons.forEach(icon => {
            const iconElement = createIconElement(icon);
            activeTab.appendChild(iconElement);
        });
    }
}

// Ouvrir le s√©lecteur d'ic√¥nes
function openIconSelector(mode) {
    currentMode = mode;
    
    // R√©cup√©rer l'ic√¥ne actuelle
    let currentIcon = 'fas fa-box';
    let categoryName = '';
    
    if (mode === 'edit') {
        currentIcon = document.getElementById('editCategoryIcon').value || 'fas fa-box';
        categoryName = document.getElementById('editCategoryName').value || '';
    } else {
        currentIcon = document.getElementById('categoryIcon').value || 'fas fa-box';
        categoryName = document.getElementById('categoryName').value || '';
    }
    
    // Afficher les suggestions intelligentes si un nom de cat√©gorie est fourni
    if (categoryName.trim()) {
        showSmartSuggestions(categoryName);
    } else {
        hideSmartSuggestions();
    }
    
    // Pr√©visualiser l'ic√¥ne actuelle
    previewIcon(currentIcon);
    
    // Ouvrir le modal
    new bootstrap.Modal(document.getElementById('iconSelectorModal')).show();
}

// Afficher les suggestions intelligentes
function showSmartSuggestions(categoryName) {
    const suggestionsContainer = document.getElementById('smartSuggestions');
    const categoryNameSpan = document.getElementById('suggestionCategoryName');
    const suggestedGrid = document.getElementById('suggestedIconsGrid');
    
    if (!suggestionsContainer || !suggestedGrid || !categoryName || categoryName.length < 2) {
        hideSmartSuggestions();
        return;
    }
    
    console.log('üéØ Affichage des suggestions pour:', categoryName);
    
    // Obtenir les suggestions
    const suggestions = iconSuggestions.getMultipleSuggestions(categoryName);
    
    if (suggestions.length === 0) {
        hideSmartSuggestions();
        return;
    }
    
    // Mettre √† jour le nom de la cat√©gorie
    if (categoryNameSpan) {
        categoryNameSpan.textContent = categoryName;
    }
    
    // Vider la grille de suggestions
    suggestedGrid.innerHTML = '';
    
    // Ajouter les ic√¥nes sugg√©r√©es
    suggestions.forEach((iconClass, index) => {
        const iconElement = createSuggestionIconElement(iconClass, index === 0);
        suggestedGrid.appendChild(iconElement);
    });
    
    // Afficher le conteneur de suggestions
    suggestionsContainer.style.display = 'block';
    
    console.log('‚úÖ Suggestions affich√©es:', suggestions);
}

// Cr√©er un √©l√©ment d'ic√¥ne sp√©cial pour les suggestions
function createSuggestionIconElement(iconClass, isRecommended = false) {
    const col = document.createElement('div');
    col.className = 'col-2';
    
    const button = document.createElement('button');
    button.type = 'button';
    button.className = `btn ${isRecommended ? 'btn-primary' : 'btn-outline-primary'} w-100 suggestion-icon-btn`;
    button.style.aspectRatio = '1';
    button.style.position = 'relative';
    button.setAttribute('data-icon', iconClass);
    button.title = iconClass + (isRecommended ? ' (Recommand√©)' : '');
    button.onclick = function() { 
        previewIcon(iconClass); 
        // Mettre en surbrillance cette suggestion
        document.querySelectorAll('.suggestion-icon-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        });
        this.classList.remove('btn-outline-primary');
        this.classList.add('btn-primary');
    };
    
    const icon = document.createElement('i');
    icon.className = iconClass;
    icon.style.fontSize = '1.2rem';
    
    button.appendChild(icon);
    
    // Ajouter un badge "Recommand√©" pour la premi√®re suggestion
    if (isRecommended) {
        const badge = document.createElement('span');
        badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success';
        badge.style.fontSize = '0.6rem';
        badge.textContent = '‚òÖ';
        button.appendChild(badge);
    }
    
    col.appendChild(button);
    
    return col;
}

// Masquer les suggestions intelligentes
function hideSmartSuggestions() {
    const suggestionsContainer = document.getElementById('smartSuggestions');
    if (suggestionsContainer) {
        suggestionsContainer.style.display = 'none';
    }
}

// Mettre √† jour les suggestions en temps r√©el quand l'utilisateur tape un nom
function setupSmartSuggestions() {
    // Pour le formulaire d'ajout
    const addNameInput = document.getElementById('categoryName');
    if (addNameInput) {
        addNameInput.addEventListener('input', function() {
            const nameValue = this.value.trim();
            console.log('üîç Nom saisi:', nameValue);
            
            if (nameValue.length >= 2) {
                // Sugg√©rer automatiquement une ic√¥ne
                const suggestedIcon = iconSuggestions.suggest(nameValue);
                const iconInput = document.getElementById('categoryIcon');
                const iconPreview = document.getElementById('categoryIconPreview');
                
                console.log('üí° Ic√¥ne sugg√©r√©e:', suggestedIcon);
                
                // Mettre √† jour l'ic√¥ne sugg√©r√©e
                if (iconInput) {
                    iconInput.value = suggestedIcon;
                    // D√©clencher l'√©v√©nement input pour mettre √† jour l'aper√ßu
                    iconInput.dispatchEvent(new Event('input'));
                }
                
                if (iconPreview) {
                    iconPreview.className = suggestedIcon;
                }
                
                // Afficher un petit indicateur de suggestion
                showSuggestionIndicator(nameValue, suggestedIcon);
            } else {
                // Remettre l'ic√¥ne par d√©faut si le nom est trop court
                const iconInput = document.getElementById('categoryIcon');
                const iconPreview = document.getElementById('categoryIconPreview');
                
                if (iconInput && iconInput.value !== 'fas fa-box') {
                    iconInput.value = 'fas fa-box';
                    iconInput.dispatchEvent(new Event('input'));
                }
                
                if (iconPreview) {
                    iconPreview.className = 'fas fa-box';
                }
                
                hideSuggestionIndicator();
            }
        });
    }
    
    // Pour le formulaire d'√©dition
    const editNameInput = document.getElementById('editCategoryName');
    if (editNameInput) {
        editNameInput.addEventListener('input', function() {
            const nameValue = this.value.trim();
            console.log('üîç Nom modifi√©:', nameValue);
            
            if (nameValue.length >= 2) {
                // Sugg√©rer automatiquement une ic√¥ne
                const suggestedIcon = iconSuggestions.suggest(nameValue);
                const iconInput = document.getElementById('editCategoryIcon');
                const iconPreview = document.getElementById('editCategoryIconPreview');
                
                console.log('üí° Ic√¥ne sugg√©r√©e pour √©dition:', suggestedIcon);
                
                // Mettre √† jour l'ic√¥ne sugg√©r√©e
                if (iconInput) {
                    iconInput.value = suggestedIcon;
                    iconInput.dispatchEvent(new Event('input'));
                }
                
                if (iconPreview) {
                    iconPreview.className = suggestedIcon;
                }
            }
        });
    }
}

// Afficher un indicateur de suggestion
function showSuggestionIndicator(categoryName, suggestedIcon) {
    // Chercher s'il y a d√©j√† un indicateur
    let indicator = document.getElementById('suggestionIndicator');
    
    if (!indicator) {
        // Cr√©er l'indicateur
        indicator = document.createElement('div');
        indicator.id = 'suggestionIndicator';
        indicator.className = 'alert alert-info alert-dismissible fade show mt-2';
        indicator.style.fontSize = '0.85rem';
        
        // Ins√©rer apr√®s le champ nom de cat√©gorie
        const nameField = document.getElementById('categoryName') || document.getElementById('editCategoryName');
        if (nameField && nameField.parentElement) {
            nameField.parentElement.appendChild(indicator);
        }
    }
    
    indicator.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="${suggestedIcon} me-2 text-primary"></i>
            <span><strong>Suggestion:</strong> Ic√¥ne "${suggestedIcon}" pour "${categoryName}"</span>
            <button type="button" class="btn-close btn-close-sm ms-auto" onclick="hideSuggestionIndicator()"></button>
        </div>
    `;
}

// Masquer l'indicateur de suggestion
function hideSuggestionIndicator() {
    const indicator = document.getElementById('suggestionIndicator');
    if (indicator) {
        indicator.remove();
    }
}

// S√©lectionner l'ic√¥ne et fermer le modal
function selectIcon() {
    const targetInput = currentMode === 'edit' ? 'editCategoryIcon' : 'categoryIcon';
    const targetPreview = currentMode === 'edit' ? 'editCategoryIconPreview' : 'categoryIconPreview';
    
    // Mettre √† jour l'input
    document.getElementById(targetInput).value = selectedIcon;
    
    // Mettre √† jour l'aper√ßu
    const preview = document.getElementById(targetPreview);
    if (preview) {
        preview.className = selectedIcon;
    }
    
    // Fermer le modal
    bootstrap.Modal.getInstance(document.getElementById('iconSelectorModal')).hide();
}

// Mettre √† jour l'aper√ßu en temps r√©el lors de la frappe
function updateIconPreview(inputId, previewId) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    
    if (input && preview) {
        input.addEventListener('input', function() {
            const iconClass = this.value || 'fas fa-box';
            preview.className = iconClass;
        });
    }
}

function editCategory(id, name, description, icon) {
    document.getElementById('editCategoryName').value = name;
    document.getElementById('editCategoryDescription').value = description;
    document.getElementById('editCategoryIcon').value = icon;
    
    // Mettre √† jour l'aper√ßu de l'ic√¥ne
    const preview = document.getElementById('editCategoryIconPreview');
    if (preview) {
        preview.className = icon || 'fas fa-box';
    }
    
    document.getElementById('editCategoryForm').action = `/admin/categories/${id}/edit`;
    new bootstrap.Modal(document.getElementById('editCategoryModal')).show();
}

function toggleCategory(id, activate) {
    const action = activate ? 'activer' : 'd√©sactiver';
    if (confirm(`√ätes-vous s√ªr de vouloir ${action} cette cat√©gorie ?`)) {
        // Faire une requ√™te AJAX vers la route de toggle
        fetch(`/admin/categories/${id}/toggle-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Afficher le message de succ√®s
                showAlert(data.message, 'success');
                
                // Mettre √† jour l'interface
                const categoryCard = document.querySelector(`[data-category-id="${id}"]`).closest('.card');
                const statusBadge = categoryCard.querySelector('.badge');
                const toggleButton = categoryCard.querySelector('.toggle-category-btn');
                const toggleIcon = toggleButton.querySelector('i');
                
                // Mettre √† jour le badge de statut
                statusBadge.className = `badge ${data.status_class === 'success' ? 'bg-success' : 'bg-secondary'}`;
                statusBadge.textContent = data.status_text;
                
                // Mettre √† jour le bouton de toggle
                toggleButton.className = `btn btn-outline-${data.button_class.replace('btn-', '')} toggle-category-btn`;
                toggleButton.setAttribute('data-category-active', data.status.toString());
                toggleButton.setAttribute('title', data.button_text);
                
                // Mettre √† jour l'ic√¥ne
                toggleIcon.className = `fas fa-${data.status ? 'pause' : 'play'}`;
                
                // Si il y a un avertissement sur les produits
                if (data.products_warning && data.products_count > 0) {
                    showAlert(`‚ö†Ô∏è ${data.products_count} produit(s) dans cette cat√©gorie ne seront plus visibles publiquement.`, 'warning');
                }
                
                // Recharger les statistiques apr√®s un court d√©lai
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showAlert('Une erreur est survenue lors de la modification du statut.', 'danger');
        });
    }
}

function showAlert(message, type) {
    // Cr√©er et afficher une alerte Bootstrap
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Ins√©rer l'alerte en haut du contenu
    const contentArea = document.querySelector('.row.mb-4');
    contentArea.parentNode.insertBefore(alertDiv, contentArea);
    
    // Supprimer l'alerte automatiquement apr√®s 5 secondes
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

// Event listeners pour les boutons
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser le s√©lecteur d'ic√¥nes
    initIconSelector();
    
    // Mettre √† jour les aper√ßus en temps r√©el
    updateIconPreview('categoryIcon', 'categoryIconPreview');
    updateIconPreview('editCategoryIcon', 'editCategoryIconPreview');
    
    // Configurer les suggestions intelligentes
    setupSmartSuggestions();
    
    // Boutons d'√©dition
    document.querySelectorAll('.edit-category-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-category-id');
            const name = this.getAttribute('data-category-name');
            const description = this.getAttribute('data-category-description');
            const icon = this.getAttribute('data-category-icon');
            editCategory(id, name, description, icon);
        });
    });
    
    // Boutons de toggle
    document.querySelectorAll('.toggle-category-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-category-id');
            const isActive = this.getAttribute('data-category-active') === 'true';
            toggleCategory(id, !isActive);
        });
    });
    
    // Bouton d'ouverture du s√©lecteur d'ic√¥nes pour l'ajout
    const addIconSelectorBtn = document.querySelector('[data-bs-target="#iconSelectorModal"]');
    if (addIconSelectorBtn) {
        addIconSelectorBtn.addEventListener('click', function() {
            openIconSelector('add');
        });
    }
});
</script>
{% endblock %}

{% extends 'admin/layout.html' %}

{% block title %}Éditer {{ product.name }} - DOUKA KM{% endblock %}
{% block page_title %}Éditer le produit{% endblock %}

{% block admin_content %}
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-edit me-2"></i> Éditer : {{ product.name }}
                        </h5>
                        <div>
                            <a href="{{ url_for('product_detail', product_id=product.id) }}" class="btn btn-outline-info btn-sm me-2">
                                <i class="fas fa-eye me-1"></i> Voir
                            </a>
                            <a href="{{ url_for('admin_products') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i> Retour
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST" id="productEditForm">
                        <!-- Informations de base -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-info-circle me-2"></i> Informations de base
                                </h6>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">Nom du produit <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="name" name="name" value="{{ product.name }}" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="price" class="form-label">Prix (KMF) <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="price" name="price" value="{{ product.price }}" required min="0">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="stock" class="form-label">Stock <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="stock" name="stock" value="{{ product.stock|default(0) }}" required min="0">
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="description" name="description" rows="4" required>{{ product.description }}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Catégorisation -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-tags me-2"></i> Catégorisation
                                </h6>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="category_id" class="form-label">Catégorie</label>
                                    <select class="form-select" id="category_id" name="category_id">
                                        <option value="">Choisir une catégorie</option>
                                        {% for category in categories %}
                                            <option value="{{ category.id }}" {% if product.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="subcategory_id" class="form-label">Sous-catégorie</label>
                                    <select class="form-select" id="subcategory_id" name="subcategory_id">
                                        <option value="">Choisir une sous-catégorie</option>
                                        <!-- Les sous-catégories seront remplies dynamiquement -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="status" class="form-label">Statut</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="active" {% if product.status == 'active' %}selected{% endif %}>Actif</option>
                                        <option value="inactive" {% if product.status == 'inactive' %}selected{% endif %}>Inactif</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Images actuelles -->
                        {% if product.images %}
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-images me-2"></i> Images actuelles
                                </h6>
                            </div>
                            <div class="col-md-12">
                                <div class="row">
                                    {% for image_url in product.images %}
                                    <div class="col-md-3 mb-3">
                                        <div class="card">
                                            <img src="{{ image_url }}" class="card-img-top" style="height: 150px; object-fit: cover;" 
                                                 onerror="this.src='/static/img/placeholder.jpg'">
                                            <div class="card-body p-2">
                                                <small class="text-muted">Image {{ loop.index }}</small>
                                                {% if loop.index == 1 %}
                                                    <span class="badge bg-primary ms-2">Principal</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Informations supplémentaires -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-info me-2"></i> Informations supplémentaires
                                </h6>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">ID Produit</label>
                                    <input type="text" class="form-control" value="{{ product.id }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Source</label>
                                    <input type="text" class="form-control" value="{{ 'Admin' if product.source != 'merchant' else 'Marchand' }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Date de création</label>
                                    <input type="text" class="form-control" value="{{ product.created_at }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Dernière modification</label>
                                    <input type="text" class="form-control" value="{{ product.updated_at }}" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Options existantes -->
                        {% if product.colors or product.sizes or product.specifications %}
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-palette me-2"></i> Options existantes
                                </h6>
                            </div>
                            
                            {% if product.colors %}
                            <div class="col-md-4">
                                <label class="form-label">Couleurs</label>
                                <div class="mb-3">
                                    {% for color in product.colors %}
                                    <span class="badge me-2 mb-1" style="background-color: {{ color.hex }}; color: white;">
                                        {{ color.name }}
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            {% if product.sizes %}
                            <div class="col-md-4">
                                <label class="form-label">Tailles</label>
                                <div class="mb-3">
                                    {% for size in product.sizes %}
                                    <span class="badge bg-secondary me-2 mb-1">
                                        {{ size.label or size.value }}
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            {% if product.specifications %}
                            <div class="col-md-4">
                                <label class="form-label">Spécifications</label>
                                <div class="mb-3">
                                    {% for spec_name, spec_value in product.specifications.items() %}
                                    <div class="small mb-1">
                                        <strong>{{ spec_name }}:</strong> {{ spec_value }}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Avertissement pour produits marchands -->
                        {% if product.source == 'merchant' %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Attention :</strong> Ce produit appartient à un marchand. Les modifications seront appliquées directement à leur inventaire.
                        </div>
                        {% endif %}

                        <!-- Boutons d'action -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="d-flex justify-content-end gap-2">
                                    <a href="{{ url_for('admin_products') }}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i> Annuler
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i> Sauvegarder les modifications
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// Gestion des sous-catégories dynamiques
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('category_id');
    const subcategorySelect = document.getElementById('subcategory_id');
    
    const subcategories = {
        {% for category in categories %}
            '{{ category.id }}': [
                {% for subcategory in category.subcategories %}
                    { id: '{{ subcategory.id }}', name: '{{ subcategory.name }}' },
                {% endfor %}
            ],
        {% endfor %}
    };
    
    // Fonction pour remplir les sous-catégories
    function populateSubcategories(categoryId, selectedSubcategoryId = null) {
        subcategorySelect.innerHTML = '<option value="">Choisir une sous-catégorie</option>';
        
        if (categoryId && subcategories[categoryId]) {
            subcategories[categoryId].forEach(function(subcategory) {
                const option = document.createElement('option');
                option.value = subcategory.id;
                option.textContent = subcategory.name;
                if (selectedSubcategoryId && subcategory.id == selectedSubcategoryId) {
                    option.selected = true;
                }
                subcategorySelect.appendChild(option);
            });
        }
    }
    
    // Initialiser les sous-catégories avec la valeur actuelle
    const currentCategoryId = categorySelect.value;
    const currentSubcategoryId = {% if product.subcategory_id %}{{ product.subcategory_id }}{% else %}null{% endif %};
    if (currentCategoryId) {
        populateSubcategories(currentCategoryId, currentSubcategoryId);
    }
    
    // Écouter les changements de catégorie
    categorySelect.addEventListener('change', function() {
        populateSubcategories(this.value);
    });
});

// Confirmation avant sauvegarde si c'est un produit marchand
document.getElementById('productEditForm').addEventListener('submit', function(e) {
    {% if product.source == 'merchant' %}
    if (!confirm('Êtes-vous sûr de vouloir modifier ce produit marchand ? Les changements seront visibles pour le marchand.')) {
        e.preventDefault();
    }
    {% endif %}
});
</script>
{% endblock %}
